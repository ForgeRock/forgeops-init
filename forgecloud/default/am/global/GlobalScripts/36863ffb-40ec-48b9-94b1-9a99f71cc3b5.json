{
  "metadata" : {
    "realm" : null,
    "amsterVersion" : "6.0.0",
    "entityType" : "GlobalScripts",
    "entityId" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "pathParams" : { }
  },
  "data" : {
    "_id" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "createdBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedDate" : "1433147666269",
    "lastModifiedBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "name" : "OIDC Claims Script",
    "context" : "OIDC_CLAIMS",
    "description" : "Default global script for OIDC claims",
    "language" : "GROOVY",
    "creationDate" : "1433147666269",
    "script" : "LyoNCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgRm9yZ2VSb2NrIEFTLiBBbGwgUmlnaHRzIFJlc2VydmVkDQogKg0KICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4NCiAqIG9yIHdpdGggb25lIG9mIGl0cyBhZmZpbGlhdGVzLiBBbGwgdXNlIHNoYWxsIGJlIGV4Y2x1c2l2ZWx5IHN1YmplY3QNCiAqIHRvIHN1Y2ggbGljZW5zZSBiZXR3ZWVuIHRoZSBsaWNlbnNlZSBhbmQgRm9yZ2VSb2NrIEFTLg0KICovDQppbXBvcnQgY29tLmlwbGFuZXQuc3NvLlNTT0V4Y2VwdGlvbg0KaW1wb3J0IGNvbS5zdW4uaWRlbnRpdHkuaWRtLklkUmVwb0V4Y2VwdGlvbg0KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuZXhjZXB0aW9ucy5JbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbg0KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuVXNlckluZm9DbGFpbXMNCmltcG9ydCBvcmcuZm9yZ2Vyb2NrLm9wZW5pZGNvbm5lY3QuQ2xhaW0NCmltcG9ydCBncm9vdnkuanNvbi5Kc29uU2x1cnBlcg0KLyoNCiogRGVmaW5lZCB2YXJpYWJsZXM6DQoqIGxvZ2dlciAtIGFsd2F5cyBwcmVzZW50cywgdGhlICJPQXV0aDJQcm92aWRlciIgZGVidWcgbG9nZ2VyIGluc3RhbmNlDQoqIGNsYWltcyAtIGFsd2F5cyBwcmVzZW50LCBkZWZhdWx0IHNlcnZlciBwcm92aWRlZCBjbGFpbXMgLSBNYXA8U3RyaW5nLCBPYmplY3Q+DQoqIGNsYWltT2JqZWN0cyAtIGFsd2F5cyBwcmVzZW50LCBkZWZhdWx0IHNlcnZlciBwcm92aWRlZCBjbGFpbXMgLSBMaXN0PENsYWltPg0KKiBzZXNzaW9uIC0gcHJlc2VudCBpZiB0aGUgcmVxdWVzdCBjb250YWlucyB0aGUgc2Vzc2lvbiBjb29raWUsIHRoZSB1c2VyJ3Mgc2Vzc2lvbiBvYmplY3QNCiogaWRlbnRpdHkgLSBhbHdheXMgcHJlc2VudCwgdGhlIGlkZW50aXR5IG9mIHRoZSByZXNvdXJjZSBvd25lcg0KKiBzY29wZXMgLSBhbHdheXMgcHJlc2VudCwgdGhlIHJlcXVlc3RlZCBzY29wZXMNCiogcmVxdWVzdGVkQ2xhaW1zIC0gTWFwPFN0cmluZywgU2V0PFN0cmluZz4+DQoqICAgICAgICAgICAgICAgICAgYWx3YXlzIHByZXNlbnQsIG5vdCBlbXB0eSBpZiB0aGUgcmVxdWVzdCBjb250YWlucyBhIGNsYWltcyBwYXJhbWV0ZXIgYW5kIHNlcnZlciBoYXMgZW5hYmxlZA0KKiAgICAgICAgICAgICAgICAgIGNsYWltc19wYXJhbWV0ZXJfc3VwcG9ydGVkLCBtYXAgb2YgcmVxdWVzdGVkIGNsYWltcyB0byBwb3NzaWJsZSB2YWx1ZXMsIG90aGVyd2lzZSBlbXB0eSwNCiogICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggbm8gcmVxdWVzdGVkIHZhbHVlcyB3aWxsIGhhdmUgYSBrZXkgYnV0IG5vIHZhbHVlIGluIHRoZSBtYXAuIEEga2V5IHdpdGgNCiogICAgICAgICAgICAgICAgICBhIHNpbmdsZSB2YWx1ZSBpbiBpdHMgU2V0IGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLg0KKiByZXF1ZXN0ZWRUeXBlZENsYWltcyAtIExpc3Q8Q2xhaW0+DQoqICAgICAgICAgICAgICAgICAgICAgICBhbHdheXMgcHJlc2VudCwgbm90IGVtcHR5IGlmIHRoZSByZXF1ZXN0IGNvbnRhaW5zIGEgY2xhaW1zIHBhcmFtZXRlciBhbmQgc2VydmVyIGhhcyBlbmFibGVkDQoqICAgICAgICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1hdGVyX3N1cHBvcnRlZCwgbGlzdCBvZiByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggY2xhaW0gbmFtZSwgcmVxdWVzdGVkIHBvc3NpYmxlIHZhbHVlcw0KKiAgICAgICAgICAgICAgICAgICAgICAgYW5kIGlmIGNsYWltIGlzIGVzc2VudGlhbCwgb3RoZXJ3aXNlIGVtcHR5LA0KKiAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdGVkIGNsYWltcyB3aXRoIG5vIHJlcXVlc3RlZCB2YWx1ZXMgd2lsbCBoYXZlIGEgY2xhaW0gd2l0aCBubyB2YWx1ZXMuIEEgY2xhaW1zIHdpdGgNCiogICAgICAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLg0KKiBjbGFpbXNMb2NhbGVzIC0gdGhlIHZhbHVlcyBmcm9tIHRoZSAnY2xhaW1zX2xvY2FsZXMnIHBhcmFtZXRlciAtIExpc3Q8U3RyaW5nPg0KKiBSZXF1aXJlZCB0byByZXR1cm4gYSBNYXAgb2YgY2xhaW1zIHRvIGJlIGFkZGVkIHRvIHRoZSBpZF90b2tlbiBjbGFpbXMNCioNCiogRXhwZWN0ZWQgcmV0dXJuIHZhbHVlIHN0cnVjdHVyZToNCiogVXNlckluZm9DbGFpbXMgew0KKiAgICBNYXA8U3RyaW5nLCBPYmplY3Q+IHZhbHVlczsgLy8gVGhlIHZhbHVlcyBvZiB0aGUgY2xhaW1zIGZvciB0aGUgdXNlciBpbmZvcm1hdGlvbg0KKiAgICBNYXA8U3RyaW5nLCBMaXN0PFN0cmluZz4+IGNvbXBvc2l0ZVNjb3BlczsgLy8gTWFwcGluZyBvZiBzY29wZSBuYW1lIHRvIGEgbGlzdCBvZiBjbGFpbSBuYW1lcy4NCiogfQ0KKi8NCg0KLy8gdXNlciBzZXNzaW9uIG5vdCBndWFyYW50ZWVkIHRvIGJlIHByZXNlbnQNCmJvb2xlYW4gc2Vzc2lvblByZXNlbnQgPSBzZXNzaW9uICE9IG51bGwNCg0KLyoNCiAqIFB1bGxzIGZpcnN0IHZhbHVlIGZyb20gdXNlcnMgcHJvZmlsZSBhdHRyaWJ1dGUNCiAqDQogKiBAcGFyYW0gY2xhaW0gVGhlIGNsYWltIG9iamVjdC4NCiAqIEBwYXJhbSBhdHRyIFRoZSBwcm9maWxlIGF0dHJpYnV0ZSBuYW1lLg0KICovDQpkZWYgZnJvbVNldCA9IHsgY2xhaW0sIGF0dHIgLT4NCiAgICBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID09IDEpew0KICAgICAgICBhdHRyLml0ZXJhdG9yKCkubmV4dCgpDQogICAgfSBlbHNlIGlmIChhdHRyICE9IG51bGwgJiYgYXR0ci5zaXplKCkgPiAxKXsNCiAgICAgICAgYXR0cg0KICAgIH0gZWxzZSBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsNCiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IEdvdCBhbiBlbXB0eSByZXN1bHQgZm9yIGNsYWltPSRjbGFpbSIpOw0KICAgIH0NCn0NCg0KLy8gLS0tdnZ2dnZ2dnZ2di0tLSBFWEFNUExFIENMQUlNIEFUVFJJQlVURSBSRVNPTFZFUiBGVU5DVElPTlMgLS0tdnZ2dnZ2dnZ2di0tLQ0KLyoNCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gZnJvbSBpdHMgcmVxdWVzdGVkIHZhbHVlcy4NCiAqDQogKiBUaGlzIHJlc29sdmVyIHdpbGwgcmV0dXJuIGEgdmFsdWUgaWYgdGhlIGNsYWltIGhhcyBvbmUgcmVxdWVzdGVkIHZhbHVlcywgb3RoZXJ3aXNlIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uDQogKi8NCmRlZmF1bHRDbGFpbVJlc29sdmVyID0geyBjbGFpbSAtPg0KICAgIGlmIChjbGFpbS5nZXRWYWx1ZXMoKS5zaXplKCkgPT0gMSkgew0KICAgICAgICBbKGNsYWltLmdldE5hbWUoKSk6IGNsYWltLmdldFZhbHVlcygpLml0ZXJhdG9yKCkubmV4dCgpXQ0KICAgIH0gZWxzZSB7DQogICAgICAgIFs6XQ0KICAgIH0NCn0NCg0KLyoNCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gYnkgbG9va2luZyB1cCB0aGUgdXNlcidzIHByb2ZpbGUuDQogKg0KICogVGhpcyByZXNvbHZlciB3aWxsIHJldHVybiBhIHZhbHVlIGZvciB0aGUgY2xhaW0gaWY6DQogKiAjIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgaXMgbm90IG51bGwNCiAqICMgQU5EIHRoZSBjbGFpbSBjb250YWlucyBubyByZXF1ZXN0ZWQgdmFsdWVzDQogKiAjIE9SIHRoZSBjbGFpbSBjb250YWlucyByZXF1ZXN0ZWQgdmFsdWVzIGFuZCB0aGUgdmFsdWUgZnJvbSB0aGUgdXNlcidzIHByb2ZpbGUgaXMgaW4gdGhlIGxpc3Qgb2YgdmFsdWVzDQogKg0KICogSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4NCiAqLw0KDQpuYW1lUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+DQogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkNCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsgDQogICAgICAgIGRlZiB2YWx1ZSA9IHRvSnNvbih1c2VyUHJvZmlsZVZhbHVlKQ0KICAgICAgICAvLyBAdG9kbyBuYW1lIGluY2x1ZGluZyBhbGwgbmFtZSBwYXJ0cywgcG9zc2libHkgaW5jbHVkaW5nIHRpdGxlcyBhbmQgc3VmZml4ZXMsIG9yZGVyZWQgYWNjb3JkaW5nIHRvIHRoZSBFbmQtVXNlcidzIGxvY2FsZSBhbmQgcHJlZmVyZW5jZXMuDQogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGdyb292eS5qc29uLmludGVybmFsLkxhenlNYXApIHsNCiAgICAgICAgICAgIGlmICh2YWx1ZS5naXZlbk5hbWUgJiYgdmFsdWUuZmFtaWx5TmFtZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBbDQogICAgICAgICAgICAgICAgICAgICJmYW1pbHlfbmFtZSI6IHZhbHVlLmZhbWlseU5hbWUsDQogICAgICAgICAgICAgICAgICAgICJnaXZlbl9uYW1lIjogdmFsdWUuZ2l2ZW5OYW1lLA0KICAgICAgICAgICAgICAgICAgICAibmFtZSI6ICIkdmFsdWUuZ2l2ZW5OYW1lICR2YWx1ZS5mYW1pbHlOYW1lIi50cmltKCksDQogICAgICAgICAgICAgICAgXQ0KICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5mYW1pbHlOYW1lKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFsNCiAgICAgICAgICAgICAgICAgICAgImZhbWlseV9uYW1lIjogdmFsdWUuZmFtaWx5TmFtZSwNCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZS5mYW1pbHlOYW1lLA0KICAgICAgICAgICAgICAgIF0NCiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUuZ2l2ZW5OYW1lKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFsNCiAgICAgICAgICAgICAgICAgICAgImdpdmVuX25hbWUiOiB2YWx1ZS5naXZlbk5hbWUsDQogICAgICAgICAgICAgICAgICAgICJuYW1lIjogdmFsdWUuZ2l2ZW5OYW1lLA0KICAgICAgICAgICAgICAgIF0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBbDQogICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZSwNCiAgICAgICAgICAgIF0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiBbDQogICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZSwNCiAgICAgICAgICAgIF0NCiAgICAgICAgfQ0KICAgIH0NCiAgICBbOl0NCn0NCg0KYXR0cmlidXRlUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgZmllbGQsIHVzZVByaW1hcnksIGFkZFZlcmlmaWVkLCBjbGFpbSwgaWRlbnRpdHkgLT4NCiAgICBuYW1lID0gY2xhaW0uZ2V0TmFtZSgpDQogICAgdmFsdWUgPSBmcm9tU2V0KG5hbWUsIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQ0KICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh2YWx1ZSkpKSB7IA0KICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSkNCiAgICAgICAgaWYgKHVzZVByaW1hcnkpIHsNCiAgICAgICAgICAgIHZhbHVlID0gZ2V0UHJpbWFyeU9yRmlyc3QodmFsdWUpDQogICAgICAgIH0NCiAgICAgICAgaWYgKGFkZFZlcmlmaWVkKSB7DQogICAgICAgICAgICByZXR1cm4gWw0KICAgICAgICAgICAgICAgICgiJHtuYW1lfV92ZXJpZmllZCIpOiB2YWx1ZS52ZXJpZmllZCA9PSB0cnVlID8gdHJ1ZSA6IGZhbHNlLA0KICAgICAgICAgICAgICAgIChuYW1lKTogZmllbGQgPyB2YWx1ZVtmaWVsZF0gOiB2YWx1ZSwNCiAgICAgICAgICAgIF0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gWw0KICAgICAgICAgICAgKG5hbWUpOiBmaWVsZCA/IHZhbHVlW2ZpZWxkXSA6IHZhbHVlLA0KICAgICAgICBdDQogICAgfQ0KICAgIFs6XQ0KfQ0KDQpiYXNpY1Jlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPg0KICAgIG5hbWUgPSBjbGFpbS5nZXROYW1lKCkNCiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChuYW1lLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkNCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsgDQogICAgICAgIGRlZiB2YWx1ZSA9IHRvSnNvbih1c2VyUHJvZmlsZVZhbHVlKQ0KICAgICAgICB2YWx1ZSA9IGdldFByaW1hcnlPckZpcnN0KHZhbHVlKQ0KICAgICAgICByZXR1cm4gWyhuYW1lKTogdmFsdWVdDQogICAgfQ0KICAgIFs6XQ0KfQ0KDQpnZXRQcmltYXJ5T3JGaXJzdCA9IHsgdmFsdWUgLT4NCiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBqYXZhLnV0aWwuQXJyYXlMaXN0KSB7DQogICAgICAgIC8vIGxvb2sgZm9yIHByaW1hcnkNCiAgICAgICAgZm9yIChpdGVtIGluIHZhbHVlKSB7DQogICAgICAgICAgICBpZiAoaXRlbS5wcmltYXJ5KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAvLyByZXR1cm4gZmlyc3QNCiAgICAgICAgcmV0dXJuIHZhbHVlWzBdDQogICAgfQ0KICAgIHJldHVybiB2YWx1ZQ0KfQ0KDQp0b0pzb24gPSB7IHZhbHVlIC0+DQogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgamF2YS51dGlsLkhhc2hTZXQpIHsNCiAgICAgICAgZGVmIGpzb25TZXQgPSBbXQ0KICAgICAgICB2YWx1ZS5lYWNoIHsgaSAtPg0KICAgICAgICAgICAgdHJ5IHsgDQogICAgICAgICAgICAgICAganNvblNldC5hZGQodG9Kc29uKGkpKQ0KICAgICAgICAgICAgfSBjYXRjaChlKSB7DQogICAgICAgICAgICAgICAganNvblNldC5hZGQoaSkNCiAgICAgICAgICAgIH0gICAgICAgICAgICANCiAgICAgICAgfTsNCiAgICAgICAgcmV0dXJuIGpzb25TZXQNCiAgICB9DQogICAgdHJ5IHsgDQogICAgICAgIHJldHVybiBuZXcgSnNvblNsdXJwZXIoKS5wYXJzZVRleHQodmFsdWUpDQogICAgfSBjYXRjaChlKSB7DQogICAgICAgIHJldHVybiB2YWx1ZQ0KICAgIH0NCn0NCg0KDQovKg0KICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggcmVzb2x2ZXMgdGhlIHZhbHVlIG9mIHRoZSBjbGFpbSBieSBsb29raW5nIHVwIHRoZSB1c2VyJ3MgcHJvZmlsZS4NCiAqDQogKiBUaGlzIHJlc29sdmVyIHdpbGwgcmV0dXJuIGEgdmFsdWUgZm9yIHRoZSBjbGFpbSBpZjoNCiAqICMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSBpcyBub3QgbnVsbA0KICogIyBBTkQgdGhlIGNsYWltIGNvbnRhaW5zIG5vIHJlcXVlc3RlZCB2YWx1ZXMNCiAqICMgT1IgdGhlIGNsYWltIGNvbnRhaW5zIHJlcXVlc3RlZCB2YWx1ZXMgYW5kIHRoZSB2YWx1ZSBmcm9tIHRoZSB1c2VyJ3MgcHJvZmlsZSBpcyBpbiB0aGUgbGlzdCBvZiB2YWx1ZXMNCiAqDQogKiBJZiB0aGUgY2xhaW0gaXMgZXNzZW50aWFsIGFuZCBubyB2YWx1ZSBpcyBmb3VuZCBhbiBJbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBhbmQgcmV0dXJuZWQgdG8gdGhlIHVzZXIuDQogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLg0KICovDQplc3NlbnRpYWxDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPg0KICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpDQogICAgaWYgKGNsYWltLmlzRXNzZW50aWFsKCkgJiYgKHVzZXJQcm9maWxlVmFsdWUgPT0gbnVsbCB8fCB1c2VyUHJvZmlsZVZhbHVlLmlzRW1wdHkoKSkpIHsNCiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRSZXF1ZXN0RXhjZXB0aW9uKCJDb3VsZCBub3QgcHJvdmlkZSB2YWx1ZSBmb3IgZXNzZW50aWFsIGNsYWltICRjbGFpbSIpDQogICAgfQ0KICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgew0KICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiB1c2VyUHJvZmlsZVZhbHVlXQ0KICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiBbOl0NCiAgICB9DQp9DQoNCi8qDQogKiBDbGFpbSByZXNvbHZlciB3aGljaCBleHBlY3RzIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgdmFsdWUgdG8gYmUgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6DQogKiAibGFuZ3VhZ2VfdGFnfHZhbHVlX2Zvcl9sYW5ndWFnZSwuLi4iLg0KICoNCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCB0YWtlIHRoZSBsaXN0IG9mIHJlcXVlc3RlZCBsYW5ndWFnZXMgZnJvbSB0aGUgJ2NsYWltc19sb2NhbGVzJyBhdXRob3JpemUgcmVxdWVzdA0KICogcGFyYW1ldGVyIGFuZCBhdHRlbXB0IHRvIG1hdGNoIGl0IHRvIGEgdmFsdWUgZnJvbSB0aGUgdXNlcnMnIHByb2ZpbGUgYXR0cmlidXRlLg0KICogSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4NCiAqLw0KY2xhaW1Mb2NhbGVzQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4NCiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQ0KICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwpIHsNCiAgICAgICAgbG9jYWxlVmFsdWVzID0gcGFyc2VMb2NhbGVBd2FyZVN0cmluZyh1c2VyUHJvZmlsZVZhbHVlKQ0KICAgICAgICBsb2NhbGUgPSBjbGFpbXNMb2NhbGVzLmZpbmQgeyBsb2NhbGUgLT4gbG9jYWxlVmFsdWVzLmNvbnRhaW5zS2V5KGxvY2FsZSkgfQ0KICAgICAgICBpZiAobG9jYWxlICE9IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IGxvY2FsZVZhbHVlcy5nZXQobG9jYWxlKV0NCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gWzpdDQp9DQoNCi8qDQogKiBDbGFpbSByZXNvbHZlciB3aGljaCBleHBlY3RzIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgdmFsdWUgdG8gYmUgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6DQogKiAibGFuZ3VhZ2VfdGFnfHZhbHVlX2Zvcl9sYW5ndWFnZSwuLi4iLg0KICoNCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCB0YWtlIHRoZSBsYW5ndWFnZSB0YWcgc3BlY2lmaWVkIGluIHRoZSBjbGFpbSBvYmplY3QgYW5kIGF0dGVtcHQgdG8gbWF0Y2ggaXQgdG8gYSB2YWx1ZQ0KICogZnJvbSB0aGUgdXNlcnMnIHByb2ZpbGUgYXR0cmlidXRlLiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLg0KICovDQpsYW5ndWFnZVRhZ0NsYWltUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+DQogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkNCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsKSB7DQogICAgICAgIGxvY2FsZVZhbHVlcyA9IHBhcnNlTG9jYWxlQXdhcmVTdHJpbmcodXNlclByb2ZpbGVWYWx1ZSkNCiAgICAgICAgaWYgKGNsYWltLmdldExvY2FsZSgpICE9IG51bGwpIHsNCiAgICAgICAgICAgIGlmIChsb2NhbGVWYWx1ZXMuY29udGFpbnNLZXkoY2xhaW0uZ2V0TG9jYWxlKCkpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogbG9jYWxlVmFsdWVzLmdldChjbGFpbS5nZXRMb2NhbGUoKSldDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGVudHJ5ID0gbG9jYWxlVmFsdWVzLmVudHJ5U2V0KCkuaXRlcmF0b3IoKS5uZXh0KCkNCiAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkgKyAiIyIgKyBlbnRyeS5nZXRLZXkoKSk6IGVudHJ5LmdldFZhbHVlKCldDQogICAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBlbnRyeSA9IGxvY2FsZVZhbHVlcy5lbnRyeVNldCgpLml0ZXJhdG9yKCkubmV4dCgpDQogICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBlbnRyeS5nZXRWYWx1ZSgpXQ0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiBbOl0NCn0NCg0KLyoNCiAqIEdpdmVuIGEgc3RyaW5nICJlbnxFbmdsaXNoLGpwfEphcGVuZXNlLGZyX0NBfEZyZW5jaCBDYW5hZGlhbiIgd2lsbCByZXR1cm4gbWFwIG9mIGxvY2FsZSAtPiB2YWx1ZS4NCiAqLw0KcGFyc2VMb2NhbGVBd2FyZVN0cmluZyA9IHsgcyAtPg0KICAgIHJldHVybiByZXN1bHQgPSBzLnNwbGl0KCIsIikuY29sbGVjdEVudHJpZXMgeyBlbnRyeSAtPg0KICAgICAgICBzcGxpdCA9IGVudHJ5LnNwbGl0KCJcXHwiKQ0KICAgICAgICBbKHNwbGl0WzBdKTogdmFsdWUgPSBzcGxpdFsxXV0NCiAgICB9DQp9DQovLyAtLS1eXl5eXl5eXl5eLS0tIEVYQU1QTEUgQ0xBSU0gQVRUUklCVVRFIFJFU09MVkVSIEZVTkNUSU9OUyAtLS1eXl5eXl5eXl5eLS0tDQoNCi8vIC0tLS0tLS0tLS0tLS0tIFVQREFURSBUSElTIFRPIENIQU5HRSBDTEFJTSBUTyBBVFRSSUJVVEUgTUFQUElORyBGVU5DVElPTlMgLS0tLS0tLS0tLS0tLS0tDQovKg0KICogTGlzdCBvZiBjbGFpbSByZXNvbHZlciBtYXBwaW5ncy4NCiAqLw0KLy8gWyB7Y2xhaW19OiB7YXR0cmlidXRlIHJldHJpZXZlcn0sIC4uLiBdDQpjbGFpbUF0dHJpYnV0ZXMgPSBbDQogICAgICAgICJhZGRyZXNzIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1hZGRyZXNzZXMiLCBmYWxzZSwgdHJ1ZSwgZmFsc2UpLA0KICAgICAgICAiYmlydGhkYXRlIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWJpcnRoZGF0ZSIpLA0KICAgICAgICAiZW1haWwiOiBhdHRyaWJ1dGVSZXNvbHZlci5jdXJyeSgiZnItaWRtLWVtYWlscyIsICJ2YWx1ZSIsIHRydWUsIHRydWUpLA0KICAgICAgICAiZ2VuZGVyIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWdlbmRlciIpLA0KICAgICAgICAibG9jYWxlIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWxvY2FsZSIpLA0KICAgICAgICAibmFtZSI6IG5hbWVSZXNvbHZlci5jdXJyeSgiZnItaWRtLW5hbWUiKSwNCiAgICAgICAgIm5pY2tuYW1lIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLW5pY2stbmFtZSIpLA0KICAgICAgICAicGhvbmUiOiBhdHRyaWJ1dGVSZXNvbHZlci5jdXJyeSgiZnItaWRtLXBob25lLW51bWJlcnMiLCAidmFsdWUiLCB0cnVlLCB0cnVlKSwNCiAgICAgICAgInBpY3R1cmUiOiBhdHRyaWJ1dGVSZXNvbHZlci5jdXJyeSgiZnItaWRtLXBob3RvcyIsICJ2YWx1ZSIsIHRydWUsIGZhbHNlKSwNCiAgICAgICAgInByZWZlcnJlZF91c2VybmFtZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoInVzZXJOYW1lIiksDQogICAgICAgICJwcm9maWxlX3VybCI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1wcm9maWxlLXVybCIpLA0KICAgICAgICAidGl0bGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tdGl0bGUiKSwNCiAgICAgICAgInVwZGF0ZWRfYXQiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tbGFzdENoYW5nZWQiKSwNCiAgICAgICAgInVzZXJuYW1lIjogYmFzaWNSZXNvbHZlci5jdXJyeSgidXNlck5hbWUiKSwNCiAgICAgICAgIndlYnNpdGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0td2Vic2l0ZSIpLA0KICAgICAgICAiem9uZWluZm8iOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tdGltZXpvbmUiKSwNCl0NCg0KLy8gLS0tLS0tLS0tLS0tLS0gVVBEQVRFIFRISVMgVE8gQ0hBTkdFIFNDT1BFIFRPIENMQUlNIE1BUFBJTkdTIC0tLS0tLS0tLS0tLS0tDQovKg0KICogTWFwIG9mIHNjb3BlcyB0byBjbGFpbSBvYmplY3RzLg0KICovDQovLyB7c2NvcGV9OiBbIHtjbGFpbX0sIC4uLiBdDQovLyBodHRwczovL3RyZWxsby5jb20vYy93SEEzZWJwMS8xMDIxLWlkLXRva2VuLWFuZC11c2VyaW5mby1lbmRwb2ludC1ub3QtcmV0dXJuaW5nLWFsbC11c2VyLWRhdGENCnNjb3BlQ2xhaW1zTWFwID0gWw0KICAgICAgICAiZW1haWwiOiBbICJlbWFpbCIgXSwNCiAgICAgICAgImFkZHJlc3MiOiBbICJhZGRyZXNzIiBdLA0KICAgICAgICAicGhvbmUiOiBbICJwaG9uZSIgXSwNCiAgICAgICAgInByb2ZpbGUiOiBbIA0KICAgICAgICAgICAgImJpcnRoZGF0ZSIsDQogICAgICAgICAgICAiZ2VuZGVyIiwNCiAgICAgICAgICAgICJsb2NhbGUiLA0KICAgICAgICAgICAgIm5hbWUiLCANCiAgICAgICAgICAgICJuaWNrbmFtZSIsDQogICAgICAgICAgICAicGljdHVyZSIsDQogICAgICAgICAgICAicHJlZmVycmVkX3VzZXJuYW1lIiwNCiAgICAgICAgICAgICJwcm9maWxlX3VybCIsDQogICAgICAgICAgICAidGl0bGUiLCANCiAgICAgICAgICAgICJ1cGRhdGVkX2F0IiwNCiAgICAgICAgICAgICJ1c2VybmFtZSIsDQogICAgICAgICAgICAid2Vic2l0ZSIsDQogICAgICAgICAgICAiem9uZWluZm8iLCANCiAgICAgICAgICAgIC8vICJhZGRyZXNzIiwNCiAgICAgICAgXQ0KXQ0KDQovLyAtLS0tLS0tLS0tLS0tLS0tIFVQREFURSBCRUxPVyBGT1IgQURWQU5DRUQgVVNBR0VTIC0tLS0tLS0tLS0tLS0tLS0tLS0NCmlmIChsb2dnZXIubWVzc2FnZUVuYWJsZWQoKSkgew0KICAgIHNjb3Blcy5maW5kQWxsIHsgcyAtPiAhKCJvcGVuaWQiLmVxdWFscyhzKSB8fCBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzKSkgfS5lYWNoIHsgcyAtPg0KICAgICAgICBsb2dnZXIubWVzc2FnZSgiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTo6TWVzc2FnZTogc2NvcGUgbm90IGJvdW5kIHRvIGNsYWltczogJHMiKQ0KICAgIH0NCn0NCg0KLyoNCiAqIENvbXB1dGVzIHRoZSBjbGFpbXMgcmV0dXJuIGtleSBhbmQgdmFsdWUuIFRoZSBrZXkgbWF5IGJlIGEgZGlmZmVyZW50IHZhbHVlIGlmIHRoZSBjbGFpbSB2YWx1ZSBpcyBub3QgaW4NCiAqIHRoZSByZXF1ZXN0ZWQgbGFuZ3VhZ2UuDQogKi8NCmRlZiBjb21wdXRlQ2xhaW0gPSB7IGNsYWltIC0+DQogICAgdHJ5IHsNCiAgICAgICAgY2xhaW1SZXNvbHZlciA9IGNsYWltQXR0cmlidXRlcy5nZXQoY2xhaW0uZ2V0TmFtZSgpLCB7IGNsYWltT2JqLCBpZGVudGl0eSAtPiBkZWZhdWx0Q2xhaW1SZXNvbHZlcihjbGFpbSl9KQ0KICAgICAgICBjbGFpbVJlc29sdmVyKGNsYWltLCBpZGVudGl0eSkNCiAgICB9IGNhdGNoIChJZFJlcG9FeGNlcHRpb24gZSkgew0KICAgICAgICBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsNCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBVbmFibGUgdG8gcmV0cmlldmUgYXR0cmlidXRlPSRhdHRyaWJ1dGUiLCBlKTsNCiAgICAgICAgfQ0KICAgIH0gY2F0Y2ggKFNTT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgew0KICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IFVuYWJsZSB0byByZXRyaWV2ZSBhdHRyaWJ1dGU9JGF0dHJpYnV0ZSIsIGUpOw0KICAgICAgICB9DQogICAgfQ0KfQ0KDQovKg0KICogQ29udmVydHMgcmVxdWVzdGVkIHNjb3BlcyBpbnRvIGNsYWltIG9iamVjdHMgYmFzZWQgb24gdGhlIHNjb3BlIG1hcHBpbmdzIGluIHNjb3BlQ2xhaW1zTWFwLg0KICovDQpkZWYgY29udmVydFNjb3BlVG9DbGFpbXMgPSB7DQogICAgc2NvcGVzLmZpbmRBbGwgeyBzY29wZSAtPiAib3BlbmlkIiAhPSBzY29wZSAmJiBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzY29wZSkgfS5jb2xsZWN0TWFueSB7IHNjb3BlIC0+DQogICAgICAgIHNjb3BlQ2xhaW1zTWFwLmdldChzY29wZSkuY29sbGVjdCB7IGNsYWltIC0+DQogICAgICAgICAgICBuZXcgQ2xhaW0oY2xhaW0pDQogICAgICAgIH0NCiAgICB9DQp9DQoNCi8vIENyZWF0ZXMgYSBmdWxsIGxpc3Qgb2YgY2xhaW1zIHRvIHJlc29sdmUgZnJvbSByZXF1ZXN0ZWQgc2NvcGVzLCBjbGFpbXMgcHJvdmlkZWQgYnkgQVMgYW5kIHJlcXVlc3RlZCBjbGFpbXMNCmRlZiBjbGFpbXNUb1Jlc29sdmUgPSBjb252ZXJ0U2NvcGVUb0NsYWltcygpICsgY2xhaW1PYmplY3RzICsgcmVxdWVzdGVkVHlwZWRDbGFpbXMNCg0KLy8gQ29tcHV0ZXMgdGhlIGNsYWltIHJldHVybiBrZXkgYW5kIHZhbHVlcyBmb3IgYWxsIHJlcXVlc3RlZCBjbGFpbXMNCmNvbXB1dGVkQ2xhaW1zID0gY2xhaW1zVG9SZXNvbHZlLmNvbGxlY3RFbnRyaWVzKCkgeyBjbGFpbSAtPg0KICAgIHJlc3VsdCA9IGNvbXB1dGVDbGFpbShjbGFpbSkNCn0NCg0KLy8gQ29tcHV0ZXMgY29tcG9zaXRlIHNjb3Blcw0KZGVmIGNvbXBvc2l0ZVNjb3BlcyA9IHNjb3BlQ2xhaW1zTWFwLmZpbmRBbGwgeyBzY29wZSAtPg0KICAgIHNjb3Blcy5jb250YWlucyhzY29wZS5rZXkpDQp9DQoNCnJldHVybiBuZXcgVXNlckluZm9DbGFpbXMoKE1hcCljb21wdXRlZENsYWltcywgKE1hcCljb21wb3NpdGVTY29wZXMp",
    "_type" : {
      "_id" : "globalScript",
      "name" : "Scripting",
      "collection" : true
    }
  }
}