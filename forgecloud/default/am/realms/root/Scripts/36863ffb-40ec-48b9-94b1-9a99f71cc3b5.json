{
  "metadata": {
    "realm": "/",
    "amsterVersion": "&{version}",
    "entityType": "Scripts",
    "entityId": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "pathParams": {}
  },
  "data": {
    "_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "name": "OIDC Claims Script",
    "description": "Default global script for OIDC claims",
    "script": "LyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBGb3JnZVJvY2sgQVMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQKICoKICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4KICogb3Igd2l0aCBvbmUgb2YgaXRzIGFmZmlsaWF0ZXMuIEFsbCB1c2Ugc2hhbGwgYmUgZXhjbHVzaXZlbHkgc3ViamVjdAogKiB0byBzdWNoIGxpY2Vuc2UgYmV0d2VlbiB0aGUgbGljZW5zZWUgYW5kIEZvcmdlUm9jayBBUy4KICovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuZXhjZXB0aW9ucy5JbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbgppbXBvcnQgb3JnLmZvcmdlcm9jay5vYXV0aDIuY29yZS5Vc2VySW5mb0NsYWltcwppbXBvcnQgb3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0LkNsYWltCmltcG9ydCBncm9vdnkuanNvbi5Kc29uU2x1cnBlcgoKLyoKKiBEZWZpbmVkIHZhcmlhYmxlczoKKiBsb2dnZXIgLSBhbHdheXMgcHJlc2VudHMsIHRoZSAiT0F1dGgyUHJvdmlkZXIiIGRlYnVnIGxvZ2dlciBpbnN0YW5jZQoqIGNsYWltcyAtIGFsd2F5cyBwcmVzZW50LCBkZWZhdWx0IHNlcnZlciBwcm92aWRlZCBjbGFpbXMgLSBNYXA8U3RyaW5nLCBPYmplY3Q+CiogY2xhaW1PYmplY3RzIC0gYWx3YXlzIHByZXNlbnQsIGRlZmF1bHQgc2VydmVyIHByb3ZpZGVkIGNsYWltcyAtIExpc3Q8Q2xhaW0+Ciogc2Vzc2lvbiAtIHByZXNlbnQgaWYgdGhlIHJlcXVlc3QgY29udGFpbnMgdGhlIHNlc3Npb24gY29va2llLCB0aGUgdXNlcidzIHNlc3Npb24gb2JqZWN0CiogaWRlbnRpdHkgLSBhbHdheXMgcHJlc2VudCwgdGhlIGlkZW50aXR5IG9mIHRoZSByZXNvdXJjZSBvd25lcgoqIHNjb3BlcyAtIGFsd2F5cyBwcmVzZW50LCB0aGUgcmVxdWVzdGVkIHNjb3BlcwoqIHJlcXVlc3RlZENsYWltcyAtIE1hcDxTdHJpbmcsIFNldDxTdHJpbmc+PgoqICAgICAgICAgICAgICAgICAgYWx3YXlzIHByZXNlbnQsIG5vdCBlbXB0eSBpZiB0aGUgcmVxdWVzdCBjb250YWlucyBhIGNsYWltcyBwYXJhbWV0ZXIgYW5kIHNlcnZlciBoYXMgZW5hYmxlZAoqICAgICAgICAgICAgICAgICAgY2xhaW1zX3BhcmFtZXRlcl9zdXBwb3J0ZWQsIG1hcCBvZiByZXF1ZXN0ZWQgY2xhaW1zIHRvIHBvc3NpYmxlIHZhbHVlcywgb3RoZXJ3aXNlIGVtcHR5LAoqICAgICAgICAgICAgICAgICAgcmVxdWVzdGVkIGNsYWltcyB3aXRoIG5vIHJlcXVlc3RlZCB2YWx1ZXMgd2lsbCBoYXZlIGEga2V5IGJ1dCBubyB2YWx1ZSBpbiB0aGUgbWFwLiBBIGtleSB3aXRoCiogICAgICAgICAgICAgICAgICBhIHNpbmdsZSB2YWx1ZSBpbiBpdHMgU2V0IGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLgoqIHJlcXVlc3RlZFR5cGVkQ2xhaW1zIC0gTGlzdDxDbGFpbT4KKiAgICAgICAgICAgICAgICAgICAgICAgYWx3YXlzIHByZXNlbnQsIG5vdCBlbXB0eSBpZiB0aGUgcmVxdWVzdCBjb250YWlucyBhIGNsYWltcyBwYXJhbWV0ZXIgYW5kIHNlcnZlciBoYXMgZW5hYmxlZAoqICAgICAgICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1hdGVyX3N1cHBvcnRlZCwgbGlzdCBvZiByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggY2xhaW0gbmFtZSwgcmVxdWVzdGVkIHBvc3NpYmxlIHZhbHVlcwoqICAgICAgICAgICAgICAgICAgICAgICBhbmQgaWYgY2xhaW0gaXMgZXNzZW50aWFsLCBvdGhlcndpc2UgZW1wdHksCiogICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RlZCBjbGFpbXMgd2l0aCBubyByZXF1ZXN0ZWQgdmFsdWVzIHdpbGwgaGF2ZSBhIGNsYWltIHdpdGggbm8gdmFsdWVzLiBBIGNsYWltcyB3aXRoCiogICAgICAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLgoqIGNsYWltc0xvY2FsZXMgLSB0aGUgdmFsdWVzIGZyb20gdGhlICdjbGFpbXNfbG9jYWxlcycgcGFyYW1ldGVyIC0gTGlzdDxTdHJpbmc+CiogUmVxdWlyZWQgdG8gcmV0dXJuIGEgTWFwIG9mIGNsYWltcyB0byBiZSBhZGRlZCB0byB0aGUgaWRfdG9rZW4gY2xhaW1zCioKKiBFeHBlY3RlZCByZXR1cm4gdmFsdWUgc3RydWN0dXJlOgoqIFVzZXJJbmZvQ2xhaW1zIHsKKiAgICBNYXA8U3RyaW5nLCBPYmplY3Q+IHZhbHVlczsgLy8gVGhlIHZhbHVlcyBvZiB0aGUgY2xhaW1zIGZvciB0aGUgdXNlciBpbmZvcm1hdGlvbgoqICAgIE1hcDxTdHJpbmcsIExpc3Q8U3RyaW5nPj4gY29tcG9zaXRlU2NvcGVzOyAvLyBNYXBwaW5nIG9mIHNjb3BlIG5hbWUgdG8gYSBsaXN0IG9mIGNsYWltIG5hbWVzLgoqIH0KKi8KCi8vIHVzZXIgc2Vzc2lvbiBub3QgZ3VhcmFudGVlZCB0byBiZSBwcmVzZW50CmJvb2xlYW4gc2Vzc2lvblByZXNlbnQgPSBzZXNzaW9uICE9IG51bGwKCi8qCiAqIFB1bGxzIGZpcnN0IHZhbHVlIGZyb20gdXNlcnMgcHJvZmlsZSBhdHRyaWJ1dGUKICoKICogQHBhcmFtIGNsYWltIFRoZSBjbGFpbSBvYmplY3QuCiAqIEBwYXJhbSBhdHRyIFRoZSBwcm9maWxlIGF0dHJpYnV0ZSBuYW1lLgogKi8KZGVmIGZyb21TZXQgPSB7IGNsYWltLCBhdHRyIC0+CiAgICBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID09IDEpewogICAgICAgIGF0dHIuaXRlcmF0b3IoKS5uZXh0KCkKICAgIH0gZWxzZSBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID4gMSl7CiAgICAgICAgYXR0cgogICAgfSBlbHNlIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBHb3QgYW4gZW1wdHkgcmVzdWx0IGZvciBjbGFpbT0kY2xhaW0iKTsKICAgIH0KfQoKLy8gLS0tdnZ2dnZ2dnZ2di0tLSBFWEFNUExFIENMQUlNIEFUVFJJQlVURSBSRVNPTFZFUiBGVU5DVElPTlMgLS0tdnZ2dnZ2dnZ2di0tLQovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIGZyb20gaXRzIHJlcXVlc3RlZCB2YWx1ZXMuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBpZiB0aGUgY2xhaW0gaGFzIG9uZSByZXF1ZXN0ZWQgdmFsdWVzLCBvdGhlcndpc2UgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmRlZmF1bHRDbGFpbVJlc29sdmVyID0geyBjbGFpbSAtPgogICAgaWYgKGNsYWltLmdldFZhbHVlcygpLnNpemUoKSA9PSAxKSB7CiAgICAgICAgWyhjbGFpbS5nZXROYW1lKCkpOiBjbGFpbS5nZXRWYWx1ZXMoKS5pdGVyYXRvcigpLm5leHQoKV0KICAgIH0gZWxzZSB7CiAgICAgICAgWzpdCiAgICB9Cn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gYnkgbG9va2luZyB1cCB0aGUgdXNlcidzIHByb2ZpbGUuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBmb3IgdGhlIGNsYWltIGlmOgogKiAjIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgaXMgbm90IG51bGwKICogIyBBTkQgdGhlIGNsYWltIGNvbnRhaW5zIG5vIHJlcXVlc3RlZCB2YWx1ZXMKICogIyBPUiB0aGUgY2xhaW0gY29udGFpbnMgcmVxdWVzdGVkIHZhbHVlcyBhbmQgdGhlIHZhbHVlIGZyb20gdGhlIHVzZXIncyBwcm9maWxlIGlzIGluIHRoZSBsaXN0IG9mIHZhbHVlcwogKgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KCm5hbWVSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsgCiAgICAgICAgZGVmIHZhbHVlID0gdG9Kc29uKHVzZXJQcm9maWxlVmFsdWUpCiAgICAgICAgLy8gQHRvZG8gbmFtZSBpbmNsdWRpbmcgYWxsIG5hbWUgcGFydHMsIHBvc3NpYmx5IGluY2x1ZGluZyB0aXRsZXMgYW5kIHN1ZmZpeGVzLCBvcmRlcmVkIGFjY29yZGluZyB0byB0aGUgRW5kLVVzZXIncyBsb2NhbGUgYW5kIHByZWZlcmVuY2VzLgogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGdyb292eS5qc29uLmludGVybmFsLkxhenlNYXApIHsKICAgICAgICAgIAlpZiAodmFsdWUuZ2l2ZW5OYW1lICYmIHZhbHVlLmZhbWlseU5hbWUgJiYgdmFsdWUubWlkZGxlTmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAiZmFtaWx5X25hbWUiOiB2YWx1ZS5mYW1pbHlOYW1lLAogICAgICAgICAgICAgICAgICAgICJnaXZlbl9uYW1lIjogdmFsdWUuZ2l2ZW5OYW1lLAogICAgICAgICAgICAgICAgICAJIm1pZGRsZV9uYW1lIjogdmFsdWUubWlkZGxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6ICIkdmFsdWUuZ2l2ZW5OYW1lICR2YWx1ZS5taWRkbGVOYW1lICR2YWx1ZS5mYW1pbHlOYW1lIi50cmltKCksCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUuZ2l2ZW5OYW1lICYmIHZhbHVlLmZhbWlseU5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgImZhbWlseV9uYW1lIjogdmFsdWUuZmFtaWx5TmFtZSwKICAgICAgICAgICAgICAgICAgICAiZ2l2ZW5fbmFtZSI6IHZhbHVlLmdpdmVuTmFtZSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6ICIkdmFsdWUuZ2l2ZW5OYW1lICR2YWx1ZS5mYW1pbHlOYW1lIi50cmltKCksCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUuZmFtaWx5TmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAiZmFtaWx5X25hbWUiOiB2YWx1ZS5mYW1pbHlOYW1lLAogICAgICAgICAgICAgICAgICAgICJuYW1lIjogdmFsdWUuZmFtaWx5TmFtZSwKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5naXZlbk5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgImdpdmVuX25hbWUiOiB2YWx1ZS5naXZlbk5hbWUsCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZS5naXZlbk5hbWUsCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICJuYW1lIjogdmFsdWUsCiAgICAgICAgICAgIF0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZSwKICAgICAgICAgICAgXQogICAgICAgIH0KICAgIH0KICAgIFs6XQp9CgphdHRyaWJ1dGVSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBmaWVsZCwgdXNlUHJpbWFyeSwgYWRkVmVyaWZpZWQsIGNsYWltLCBpZGVudGl0eSAtPgogICAgbmFtZSA9IGNsYWltLmdldE5hbWUoKQogICAgbG9nZ2VyLm1lc3NhZ2UoImF0dHJpYnV0ZVJlc29sdmVyOiAiICsgbmFtZSkKICAgIHZhbHVlID0gZnJvbVNldChuYW1lLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh2YWx1ZSkpKSB7IAogICAgICAgIHZhbHVlID0gdG9Kc29uKHZhbHVlKQogICAgICAgIGlmICh1c2VQcmltYXJ5KSB7CiAgICAgICAgICAgIHZhbHVlID0gZ2V0UHJpbWFyeU9yRmlyc3QodmFsdWUpCiAgICAgICAgfQogICAgICAgIGlmIChhZGRWZXJpZmllZCkgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgKCIke25hbWV9X3ZlcmlmaWVkIik6IHZhbHVlLmhhc1Byb3BlcnR5KCJ2ZXJpZmllZCIpICYmIHZhbHVlLnZlcmlmaWVkID09IHRydWUgPyB0cnVlIDogZmFsc2UsCiAgICAgICAgICAgICAgICAobmFtZSk6IGZpZWxkICYmIHZhbHVlLmhhc1Byb3BlcnR5KGZpZWxkKSA/IHZhbHVlW2ZpZWxkXSA6IHZhbHVlLAogICAgICAgICAgICBdCiAgICAgICAgfQogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIChuYW1lKTogZmllbGQgPyB2YWx1ZVtmaWVsZF0gOiB2YWx1ZSwKICAgICAgICBdCiAgICB9CiAgICBbOl0KfQoKYmFzaWNSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIG5hbWUgPSBjbGFpbS5nZXROYW1lKCkKICAgIGxvZ2dlci5tZXNzYWdlKCJiYXNpY1Jlc29sdmVyOiAiICsgbmFtZSkKICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KG5hbWUsIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCAmJiAoY2xhaW0uZ2V0VmFsdWVzKCkgPT0gbnVsbCB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5pc0VtcHR5KCkgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuY29udGFpbnModXNlclByb2ZpbGVWYWx1ZSkpKSB7IAogICAgICAgIGRlZiB2YWx1ZSA9IHRvSnNvbih1c2VyUHJvZmlsZVZhbHVlKQogICAgICAgIHZhbHVlID0gZ2V0UHJpbWFyeU9yRmlyc3QodmFsdWUpCiAgICAgICAgcmV0dXJuIFsobmFtZSk6IHZhbHVlXQogICAgfQogICAgWzpdCn0KCmRhdGVSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIG5hbWUgPSBjbGFpbS5nZXROYW1lKCkKICAgIGxvZ2dlci5tZXNzYWdlKCJkYXRlUmVzb2x2ZXI6ICIgKyBuYW1lKQogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQobmFtZSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsgCiAgICAgIAlkZWYgdmFsdWUgPSB0b0pzb24odXNlclByb2ZpbGVWYWx1ZSkKICAgICAgCXZhbHVlID0gZ2V0UHJpbWFyeU9yRmlyc3QodmFsdWUpCiAgICAgIAlkZWYgZGF0ZSA9IERhdGUucGFyc2UoInl5eXlNTWRkSEhtbXNzIiwgdmFsdWUpOwoJCXJldHVybiBbKG5hbWUpOiBkYXRlLnRpbWUgLyAxMDAwXQogICAgfQogICAgWzpdCn0KCmdldFByaW1hcnlPckZpcnN0ID0geyB2YWx1ZSAtPgogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgamF2YS51dGlsLkFycmF5TGlzdCkgewogICAgICAgIC8vIGxvb2sgZm9yIHByaW1hcnkKICAgICAgICBmb3IgKGl0ZW0gaW4gdmFsdWUpIHsKICAgICAgICAgIAlvYmogPSB0b0pzb24oaXRlbSkKICAgICAgICAgICAgaWYgKG9iai5oYXNQcm9wZXJ0eSgicHJpbWFyeSIpICYmIG9iai5wcmltYXJ5ID09IHRydWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvYmoKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyByZXR1cm4gZmlyc3QKICAgICAgICByZXR1cm4gdG9Kc29uKHZhbHVlWzBdKQogICAgfQogICAgcmV0dXJuIHZhbHVlCn0KCnRvSnNvbiA9IHsgdmFsdWUgLT4KICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGphdmEudXRpbC5IYXNoU2V0KSB7CiAgICAgICAgZGVmIGpzb25TZXQgPSBbXQogICAgICAgIHZhbHVlLmVhY2ggeyBpIC0+CiAgICAgICAgICAgIHRyeSB7IAogICAgICAgICAgICAgICAganNvblNldC5hZGQodG9Kc29uKGkpKQogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIGpzb25TZXQuYWRkKGkpCiAgICAgICAgICAgIH0gICAgICAgICAgICAKICAgICAgICB9OwogICAgICAgIHJldHVybiBqc29uU2V0CiAgICB9CiAgICB0cnkgeyAKICAgICAgICByZXR1cm4gbmV3IEpzb25TbHVycGVyKCkucGFyc2VUZXh0KHZhbHVlKQogICAgfSBjYXRjaChlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlCiAgICB9Cn0KCgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIGJ5IGxvb2tpbmcgdXAgdGhlIHVzZXIncyBwcm9maWxlLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgcmV0dXJuIGEgdmFsdWUgZm9yIHRoZSBjbGFpbSBpZjoKICogIyB0aGUgdXNlcidzIHByb2ZpbGUgYXR0cmlidXRlIGlzIG5vdCBudWxsCiAqICMgQU5EIHRoZSBjbGFpbSBjb250YWlucyBubyByZXF1ZXN0ZWQgdmFsdWVzCiAqICMgT1IgdGhlIGNsYWltIGNvbnRhaW5zIHJlcXVlc3RlZCB2YWx1ZXMgYW5kIHRoZSB2YWx1ZSBmcm9tIHRoZSB1c2VyJ3MgcHJvZmlsZSBpcyBpbiB0aGUgbGlzdCBvZiB2YWx1ZXMKICoKICogSWYgdGhlIGNsYWltIGlzIGVzc2VudGlhbCBhbmQgbm8gdmFsdWUgaXMgZm91bmQgYW4gSW52YWxpZFJlcXVlc3RFeGNlcHRpb24gd2lsbCBiZSB0aHJvd24gYW5kIHJldHVybmVkIHRvIHRoZSB1c2VyLgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KZXNzZW50aWFsQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAoY2xhaW0uaXNFc3NlbnRpYWwoKSAmJiAodXNlclByb2ZpbGVWYWx1ZSA9PSBudWxsIHx8IHVzZXJQcm9maWxlVmFsdWUuaXNFbXB0eSgpKSkgewogICAgICAgIHRocm93IG5ldyBJbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbigiQ291bGQgbm90IHByb3ZpZGUgdmFsdWUgZm9yIGVzc2VudGlhbCBjbGFpbSAkY2xhaW0iKQogICAgfQogICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCAmJiAoY2xhaW0uZ2V0VmFsdWVzKCkgPT0gbnVsbCB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5pc0VtcHR5KCkgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuY29udGFpbnModXNlclByb2ZpbGVWYWx1ZSkpKSB7CiAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogdXNlclByb2ZpbGVWYWx1ZV0KICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFs6XQogICAgfQp9CgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCBleHBlY3RzIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgdmFsdWUgdG8gYmUgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAqICJsYW5ndWFnZV90YWd8dmFsdWVfZm9yX2xhbmd1YWdlLC4uLiIuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCB0YWtlIHRoZSBsaXN0IG9mIHJlcXVlc3RlZCBsYW5ndWFnZXMgZnJvbSB0aGUgJ2NsYWltc19sb2NhbGVzJyBhdXRob3JpemUgcmVxdWVzdAogKiBwYXJhbWV0ZXIgYW5kIGF0dGVtcHQgdG8gbWF0Y2ggaXQgdG8gYSB2YWx1ZSBmcm9tIHRoZSB1c2VycycgcHJvZmlsZSBhdHRyaWJ1dGUuCiAqIElmIG5vIG1hdGNoIGlzIGZvdW5kIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwpjbGFpbUxvY2FsZXNDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwpIHsKICAgICAgICBsb2NhbGVWYWx1ZXMgPSBwYXJzZUxvY2FsZUF3YXJlU3RyaW5nKHVzZXJQcm9maWxlVmFsdWUpCiAgICAgICAgbG9jYWxlID0gY2xhaW1zTG9jYWxlcy5maW5kIHsgbG9jYWxlIC0+IGxvY2FsZVZhbHVlcy5jb250YWluc0tleShsb2NhbGUpIH0KICAgICAgICBpZiAobG9jYWxlICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogbG9jYWxlVmFsdWVzLmdldChsb2NhbGUpXQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBbOl0KfQoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggZXhwZWN0cyB0aGUgdXNlcidzIHByb2ZpbGUgYXR0cmlidXRlIHZhbHVlIHRvIGJlIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogKiAibGFuZ3VhZ2VfdGFnfHZhbHVlX2Zvcl9sYW5ndWFnZSwuLi4iLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgdGFrZSB0aGUgbGFuZ3VhZ2UgdGFnIHNwZWNpZmllZCBpbiB0aGUgY2xhaW0gb2JqZWN0IGFuZCBhdHRlbXB0IHRvIG1hdGNoIGl0IHRvIGEgdmFsdWUKICogZnJvbSB0aGUgdXNlcnMnIHByb2ZpbGUgYXR0cmlidXRlLiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KbGFuZ3VhZ2VUYWdDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwpIHsKICAgICAgICBsb2NhbGVWYWx1ZXMgPSBwYXJzZUxvY2FsZUF3YXJlU3RyaW5nKHVzZXJQcm9maWxlVmFsdWUpCiAgICAgICAgaWYgKGNsYWltLmdldExvY2FsZSgpICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGxvY2FsZVZhbHVlcy5jb250YWluc0tleShjbGFpbS5nZXRMb2NhbGUoKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IGxvY2FsZVZhbHVlcy5nZXQoY2xhaW0uZ2V0TG9jYWxlKCkpXQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZW50cnkgPSBsb2NhbGVWYWx1ZXMuZW50cnlTZXQoKS5pdGVyYXRvcigpLm5leHQoKQogICAgICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpICsgIiMiICsgZW50cnkuZ2V0S2V5KCkpOiBlbnRyeS5nZXRWYWx1ZSgpXQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZW50cnkgPSBsb2NhbGVWYWx1ZXMuZW50cnlTZXQoKS5pdGVyYXRvcigpLm5leHQoKQogICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBlbnRyeS5nZXRWYWx1ZSgpXQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBbOl0KfQoKLyoKICogR2l2ZW4gYSBzdHJpbmcgImVufEVuZ2xpc2gsanB8SmFwZW5lc2UsZnJfQ0F8RnJlbmNoIENhbmFkaWFuIiB3aWxsIHJldHVybiBtYXAgb2YgbG9jYWxlIC0+IHZhbHVlLgogKi8KcGFyc2VMb2NhbGVBd2FyZVN0cmluZyA9IHsgcyAtPgogICAgcmV0dXJuIHJlc3VsdCA9IHMuc3BsaXQoIiwiKS5jb2xsZWN0RW50cmllcyB7IGVudHJ5IC0+CiAgICAgICAgc3BsaXQgPSBlbnRyeS5zcGxpdCgiXFx8IikKICAgICAgICBbKHNwbGl0WzBdKTogdmFsdWUgPSBzcGxpdFsxXV0KICAgIH0KfQovLyAtLS1eXl5eXl5eXl5eLS0tIEVYQU1QTEUgQ0xBSU0gQVRUUklCVVRFIFJFU09MVkVSIEZVTkNUSU9OUyAtLS1eXl5eXl5eXl5eLS0tCgovLyAtLS0tLS0tLS0tLS0tLSBVUERBVEUgVEhJUyBUTyBDSEFOR0UgQ0xBSU0gVE8gQVRUUklCVVRFIE1BUFBJTkcgRlVOQ1RJT05TIC0tLS0tLS0tLS0tLS0tLQovKgogKiBMaXN0IG9mIGNsYWltIHJlc29sdmVyIG1hcHBpbmdzLgogKi8KLy8gWyB7Y2xhaW19OiB7YXR0cmlidXRlIHJldHJpZXZlcn0sIC4uLiBdCmNsYWltQXR0cmlidXRlcyA9IFsKICAgICAgICAiYWRkcmVzcyI6IGF0dHJpYnV0ZVJlc29sdmVyLmN1cnJ5KCJmci1pZG0tYWRkcmVzc2VzIiwgZmFsc2UsIHRydWUsIGZhbHNlKSwKICAgICAgICAiYmlydGhkYXRlIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWJpcnRoZGF0ZSIpLAogICAgICAgICJlbWFpbCI6IGF0dHJpYnV0ZVJlc29sdmVyLmN1cnJ5KCJmci1pZG0tZW1haWxzIiwgInZhbHVlIiwgdHJ1ZSwgdHJ1ZSksCiAgICAgICAgImdlbmRlciI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1nZW5kZXIiKSwKICAgICAgICAibG9jYWxlIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWxvY2FsZSIpLAogICAgICAgICJuYW1lIjogbmFtZVJlc29sdmVyLmN1cnJ5KCJmci1pZG0tbmFtZS1vYmplY3QiKSwKICAgICAgICAibmlja25hbWUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tbmljay1uYW1lIiksCiAgICAgICAgInBob25lIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1waG9uZS1udW1iZXJzIiwgInZhbHVlIiwgdHJ1ZSwgZmFsc2UpLAogICAgICAgICJwaWN0dXJlIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1waG90b3MiLCAidmFsdWUiLCB0cnVlLCBmYWxzZSksCiAgICAgICAgInByZWZlcnJlZF91c2VybmFtZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoInVzZXJOYW1lIiksCiAgICAgICAgInByb2ZpbGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tcHJvZmlsZS11cmwiKSwKICAgICAgICAidGl0bGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tdGl0bGUiKSwKICAgICAgICAidXBkYXRlZF9hdCI6IGRhdGVSZXNvbHZlci5jdXJyeSgibW9kaWZ5VGltZXN0YW1wIiksCiAgICAgICAgInVzZXJuYW1lIjogYmFzaWNSZXNvbHZlci5jdXJyeSgidXNlck5hbWUiKSwKICAgICAgICAid2Vic2l0ZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS13ZWJzaXRlIiksCiAgICAgICAgInpvbmVpbmZvIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLXRpbWV6b25lIiksCl0KCi8vIC0tLS0tLS0tLS0tLS0tIFVQREFURSBUSElTIFRPIENIQU5HRSBTQ09QRSBUTyBDTEFJTSBNQVBQSU5HUyAtLS0tLS0tLS0tLS0tLQovKgogKiBNYXAgb2Ygc2NvcGVzIHRvIGNsYWltIG9iamVjdHMuCiAqLwovLyB7c2NvcGV9OiBbIHtjbGFpbX0sIC4uLiBdCi8vIGh0dHBzOi8vdHJlbGxvLmNvbS9jL3dIQTNlYnAxLzEwMjEtaWQtdG9rZW4tYW5kLXVzZXJpbmZvLWVuZHBvaW50LW5vdC1yZXR1cm5pbmctYWxsLXVzZXItZGF0YQpzY29wZUNsYWltc01hcCA9IFsKICAgICAgICAiZW1haWwiOiBbICJlbWFpbCIgXSwKICAgICAgICAiYWRkcmVzcyI6IFsgImFkZHJlc3MiIF0sCiAgICAgICAgInBob25lIjogWyAicGhvbmUiIF0sCiAgICAgICAgInByb2ZpbGUiOiBbIAogICAgICAgICAgICAiYmlydGhkYXRlIiwKICAgICAgICAgICAgImZhbWlseV9uYW1lIiwKICAgICAgICAgICAgImdlbmRlciIsCiAgICAgICAgICAgICJnaXZlbl9uYW1lIiwKICAgICAgICAgICAgImxvY2FsZSIsCiAgICAgICAgICAgICJuYW1lIiwgCiAgICAgICAgICAgICJuaWNrbmFtZSIsCiAgICAgICAgICAgICJwaWN0dXJlIiwKICAgICAgICAgICAgInByZWZlcnJlZF91c2VybmFtZSIsCiAgICAgICAgICAgICJwcm9maWxlIiwKICAgICAgICAgICAgInRpdGxlIiwgCiAgICAgICAgICAgICJ1cGRhdGVkX2F0IiwKICAgICAgICAgICAgInVzZXJuYW1lIiwKICAgICAgICAgICAgIndlYnNpdGUiLAogICAgICAgICAgICAiem9uZWluZm8iLAogICAgICAgIF0KXQoKLy8gLS0tLS0tLS0tLS0tLS0tLSBVUERBVEUgQkVMT1cgRk9SIEFEVkFOQ0VEIFVTQUdFUyAtLS0tLS0tLS0tLS0tLS0tLS0tCmlmIChsb2dnZXIubWVzc2FnZUVuYWJsZWQoKSkgewogICAgc2NvcGVzLmZpbmRBbGwgeyBzIC0+ICEoIm9wZW5pZCIuZXF1YWxzKHMpIHx8IHNjb3BlQ2xhaW1zTWFwLmNvbnRhaW5zS2V5KHMpKSB9LmVhY2ggeyBzIC0+CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6Ok1lc3NhZ2U6IHNjb3BlIG5vdCBib3VuZCB0byBjbGFpbXM6ICRzIikKICAgIH0KfQoKLyoKICogQ29tcHV0ZXMgdGhlIGNsYWltcyByZXR1cm4ga2V5IGFuZCB2YWx1ZS4gVGhlIGtleSBtYXkgYmUgYSBkaWZmZXJlbnQgdmFsdWUgaWYgdGhlIGNsYWltIHZhbHVlIGlzIG5vdCBpbgogKiB0aGUgcmVxdWVzdGVkIGxhbmd1YWdlLgogKi8KZGVmIGNvbXB1dGVDbGFpbSA9IHsgY2xhaW0gLT4KICAgIHRyeSB7CiAgICAgICAgY2xhaW1SZXNvbHZlciA9IGNsYWltQXR0cmlidXRlcy5nZXQoY2xhaW0uZ2V0TmFtZSgpLCB7IGNsYWltT2JqLCBpZGVudGl0eSAtPiBkZWZhdWx0Q2xhaW1SZXNvbHZlcihjbGFpbSl9KQogICAgICAgIGNsYWltUmVzb2x2ZXIoY2xhaW0sIGlkZW50aXR5KQogICAgfSBjYXRjaCAoSWRSZXBvRXhjZXB0aW9uIGUpIHsKICAgICAgICBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IFVuYWJsZSB0byByZXRyaWV2ZSBhdHRyaWJ1dGU9JGF0dHJpYnV0ZSIsIGUpOwogICAgICAgIH0KICAgIH0gY2F0Y2ggKFNTT0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgaWYgKGxvZ2dlci53YXJuaW5nRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBVbmFibGUgdG8gcmV0cmlldmUgYXR0cmlidXRlPSRhdHRyaWJ1dGUiLCBlKTsKICAgICAgICB9CiAgICB9Cn0KCi8qCiAqIENvbnZlcnRzIHJlcXVlc3RlZCBzY29wZXMgaW50byBjbGFpbSBvYmplY3RzIGJhc2VkIG9uIHRoZSBzY29wZSBtYXBwaW5ncyBpbiBzY29wZUNsYWltc01hcC4KICovCmRlZiBjb252ZXJ0U2NvcGVUb0NsYWltcyA9IHsKICAgIHNjb3Blcy5maW5kQWxsIHsgc2NvcGUgLT4gIm9wZW5pZCIgIT0gc2NvcGUgJiYgc2NvcGVDbGFpbXNNYXAuY29udGFpbnNLZXkoc2NvcGUpIH0uY29sbGVjdE1hbnkgeyBzY29wZSAtPgogICAgICAgIHNjb3BlQ2xhaW1zTWFwLmdldChzY29wZSkuY29sbGVjdCB7IGNsYWltIC0+CiAgICAgICAgICAgIG5ldyBDbGFpbShjbGFpbSkKICAgICAgICB9CiAgICB9Cn0KCi8vIENyZWF0ZXMgYSBmdWxsIGxpc3Qgb2YgY2xhaW1zIHRvIHJlc29sdmUgZnJvbSByZXF1ZXN0ZWQgc2NvcGVzLCBjbGFpbXMgcHJvdmlkZWQgYnkgQVMgYW5kIHJlcXVlc3RlZCBjbGFpbXMKZGVmIGNsYWltc1RvUmVzb2x2ZSA9IGNvbnZlcnRTY29wZVRvQ2xhaW1zKCkgKyBjbGFpbU9iamVjdHMgKyByZXF1ZXN0ZWRUeXBlZENsYWltcwoKLy8gQ29tcHV0ZXMgdGhlIGNsYWltIHJldHVybiBrZXkgYW5kIHZhbHVlcyBmb3IgYWxsIHJlcXVlc3RlZCBjbGFpbXMKY29tcHV0ZWRDbGFpbXMgPSBjbGFpbXNUb1Jlc29sdmUuY29sbGVjdEVudHJpZXMoKSB7IGNsYWltIC0+CiAgICBjb21wdXRlQ2xhaW0oY2xhaW0pCn0KCi8vIENvbXB1dGVzIGNvbXBvc2l0ZSBzY29wZXMKZGVmIGNvbXBvc2l0ZVNjb3BlcyA9IHNjb3BlQ2xhaW1zTWFwLmZpbmRBbGwgeyBzY29wZSAtPgogICAgc2NvcGVzLmNvbnRhaW5zKHNjb3BlLmtleSkKfQoKcmV0dXJuIG5ldyBVc2VySW5mb0NsYWltcygoTWFwKWNvbXB1dGVkQ2xhaW1zLCAoTWFwKWNvbXBvc2l0ZVNjb3Blcyk=",
    "default": true,
    "language": "GROOVY",
    "context": "OIDC_CLAIMS",
    "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "creationDate": 1433147666269,
    "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedDate": 1433147666269
  }
}
