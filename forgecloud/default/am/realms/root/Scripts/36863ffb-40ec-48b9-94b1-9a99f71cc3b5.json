{
  "metadata" : {
    "realm" : "/",
    "amsterVersion" : "6.0.0",
    "entityType" : "Scripts",
    "entityId" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "pathParams" : { }
  },
  "data" : {
    "_id" : "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "name" : "OIDC Claims Script",
    "description" : "Default global script for OIDC claims",
    "script" : "LyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBGb3JnZVJvY2sgQVMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQKICoKICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4KICogb3Igd2l0aCBvbmUgb2YgaXRzIGFmZmlsaWF0ZXMuIEFsbCB1c2Ugc2hhbGwgYmUgZXhjbHVzaXZlbHkgc3ViamVjdAogKiB0byBzdWNoIGxpY2Vuc2UgYmV0d2VlbiB0aGUgbGljZW5zZWUgYW5kIEZvcmdlUm9jayBBUy4KICovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuZXhjZXB0aW9ucy5JbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbgppbXBvcnQgb3JnLmZvcmdlcm9jay5vYXV0aDIuY29yZS5Vc2VySW5mb0NsYWltcwppbXBvcnQgb3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0LkNsYWltCmltcG9ydCBncm9vdnkuanNvbi5Kc29uU2x1cnBlcgovKgoqIERlZmluZWQgdmFyaWFibGVzOgoqIGxvZ2dlciAtIGFsd2F5cyBwcmVzZW50cywgdGhlICJPQXV0aDJQcm92aWRlciIgZGVidWcgbG9nZ2VyIGluc3RhbmNlCiogY2xhaW1zIC0gYWx3YXlzIHByZXNlbnQsIGRlZmF1bHQgc2VydmVyIHByb3ZpZGVkIGNsYWltcyAtIE1hcDxTdHJpbmcsIE9iamVjdD4KKiBjbGFpbU9iamVjdHMgLSBhbHdheXMgcHJlc2VudCwgZGVmYXVsdCBzZXJ2ZXIgcHJvdmlkZWQgY2xhaW1zIC0gTGlzdDxDbGFpbT4KKiBzZXNzaW9uIC0gcHJlc2VudCBpZiB0aGUgcmVxdWVzdCBjb250YWlucyB0aGUgc2Vzc2lvbiBjb29raWUsIHRoZSB1c2VyJ3Mgc2Vzc2lvbiBvYmplY3QKKiBpZGVudGl0eSAtIGFsd2F5cyBwcmVzZW50LCB0aGUgaWRlbnRpdHkgb2YgdGhlIHJlc291cmNlIG93bmVyCiogc2NvcGVzIC0gYWx3YXlzIHByZXNlbnQsIHRoZSByZXF1ZXN0ZWQgc2NvcGVzCiogcmVxdWVzdGVkQ2xhaW1zIC0gTWFwPFN0cmluZywgU2V0PFN0cmluZz4+CiogICAgICAgICAgICAgICAgICBhbHdheXMgcHJlc2VudCwgbm90IGVtcHR5IGlmIHRoZSByZXF1ZXN0IGNvbnRhaW5zIGEgY2xhaW1zIHBhcmFtZXRlciBhbmQgc2VydmVyIGhhcyBlbmFibGVkCiogICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1ldGVyX3N1cHBvcnRlZCwgbWFwIG9mIHJlcXVlc3RlZCBjbGFpbXMgdG8gcG9zc2libGUgdmFsdWVzLCBvdGhlcndpc2UgZW1wdHksCiogICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggbm8gcmVxdWVzdGVkIHZhbHVlcyB3aWxsIGhhdmUgYSBrZXkgYnV0IG5vIHZhbHVlIGluIHRoZSBtYXAuIEEga2V5IHdpdGgKKiAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluIGl0cyBTZXQgaW5kaWNhdGVzIHRoaXMgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBzaG91bGQgYmUgcmV0dXJuZWQuCiogcmVxdWVzdGVkVHlwZWRDbGFpbXMgLSBMaXN0PENsYWltPgoqICAgICAgICAgICAgICAgICAgICAgICBhbHdheXMgcHJlc2VudCwgbm90IGVtcHR5IGlmIHRoZSByZXF1ZXN0IGNvbnRhaW5zIGEgY2xhaW1zIHBhcmFtZXRlciBhbmQgc2VydmVyIGhhcyBlbmFibGVkCiogICAgICAgICAgICAgICAgICAgICAgIGNsYWltc19wYXJhbWF0ZXJfc3VwcG9ydGVkLCBsaXN0IG9mIHJlcXVlc3RlZCBjbGFpbXMgd2l0aCBjbGFpbSBuYW1lLCByZXF1ZXN0ZWQgcG9zc2libGUgdmFsdWVzCiogICAgICAgICAgICAgICAgICAgICAgIGFuZCBpZiBjbGFpbSBpcyBlc3NlbnRpYWwsIG90aGVyd2lzZSBlbXB0eSwKKiAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdGVkIGNsYWltcyB3aXRoIG5vIHJlcXVlc3RlZCB2YWx1ZXMgd2lsbCBoYXZlIGEgY2xhaW0gd2l0aCBubyB2YWx1ZXMuIEEgY2xhaW1zIHdpdGgKKiAgICAgICAgICAgICAgICAgICAgICAgYSBzaW5nbGUgdmFsdWUgaW5kaWNhdGVzIHRoaXMgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBzaG91bGQgYmUgcmV0dXJuZWQuCiogY2xhaW1zTG9jYWxlcyAtIHRoZSB2YWx1ZXMgZnJvbSB0aGUgJ2NsYWltc19sb2NhbGVzJyBwYXJhbWV0ZXIgLSBMaXN0PFN0cmluZz4KKiBSZXF1aXJlZCB0byByZXR1cm4gYSBNYXAgb2YgY2xhaW1zIHRvIGJlIGFkZGVkIHRvIHRoZSBpZF90b2tlbiBjbGFpbXMKKgoqIEV4cGVjdGVkIHJldHVybiB2YWx1ZSBzdHJ1Y3R1cmU6CiogVXNlckluZm9DbGFpbXMgewoqICAgIE1hcDxTdHJpbmcsIE9iamVjdD4gdmFsdWVzOyAvLyBUaGUgdmFsdWVzIG9mIHRoZSBjbGFpbXMgZm9yIHRoZSB1c2VyIGluZm9ybWF0aW9uCiogICAgTWFwPFN0cmluZywgTGlzdDxTdHJpbmc+PiBjb21wb3NpdGVTY29wZXM7IC8vIE1hcHBpbmcgb2Ygc2NvcGUgbmFtZSB0byBhIGxpc3Qgb2YgY2xhaW0gbmFtZXMuCiogfQoqLwoKLy8gdXNlciBzZXNzaW9uIG5vdCBndWFyYW50ZWVkIHRvIGJlIHByZXNlbnQKYm9vbGVhbiBzZXNzaW9uUHJlc2VudCA9IHNlc3Npb24gIT0gbnVsbAoKLyoKICogUHVsbHMgZmlyc3QgdmFsdWUgZnJvbSB1c2VycyBwcm9maWxlIGF0dHJpYnV0ZQogKgogKiBAcGFyYW0gY2xhaW0gVGhlIGNsYWltIG9iamVjdC4KICogQHBhcmFtIGF0dHIgVGhlIHByb2ZpbGUgYXR0cmlidXRlIG5hbWUuCiAqLwpkZWYgZnJvbVNldCA9IHsgY2xhaW0sIGF0dHIgLT4KICAgIGlmIChhdHRyICE9IG51bGwgJiYgYXR0ci5zaXplKCkgPT0gMSl7CiAgICAgICAgYXR0ci5pdGVyYXRvcigpLm5leHQoKQogICAgfSBlbHNlIGlmIChhdHRyICE9IG51bGwgJiYgYXR0ci5zaXplKCkgPiAxKXsKICAgICAgICBhdHRyCiAgICB9IGVsc2UgaWYgKGxvZ2dlci53YXJuaW5nRW5hYmxlZCgpKSB7CiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IEdvdCBhbiBlbXB0eSByZXN1bHQgZm9yIGNsYWltPSRjbGFpbSIpOwogICAgfQp9CgovLyAtLS12dnZ2dnZ2dnZ2LS0tIEVYQU1QTEUgQ0xBSU0gQVRUUklCVVRFIFJFU09MVkVSIEZVTkNUSU9OUyAtLS12dnZ2dnZ2dnZ2LS0tCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gZnJvbSBpdHMgcmVxdWVzdGVkIHZhbHVlcy4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHJldHVybiBhIHZhbHVlIGlmIHRoZSBjbGFpbSBoYXMgb25lIHJlcXVlc3RlZCB2YWx1ZXMsIG90aGVyd2lzZSBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KZGVmYXVsdENsYWltUmVzb2x2ZXIgPSB7IGNsYWltIC0+CiAgICBpZiAoY2xhaW0uZ2V0VmFsdWVzKCkuc2l6ZSgpID09IDEpIHsKICAgICAgICBbKGNsYWltLmdldE5hbWUoKSk6IGNsYWltLmdldFZhbHVlcygpLml0ZXJhdG9yKCkubmV4dCgpXQogICAgfSBlbHNlIHsKICAgICAgICBbOl0KICAgIH0KfQoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggcmVzb2x2ZXMgdGhlIHZhbHVlIG9mIHRoZSBjbGFpbSBieSBsb29raW5nIHVwIHRoZSB1c2VyJ3MgcHJvZmlsZS4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHJldHVybiBhIHZhbHVlIGZvciB0aGUgY2xhaW0gaWY6CiAqICMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSBpcyBub3QgbnVsbAogKiAjIEFORCB0aGUgY2xhaW0gY29udGFpbnMgbm8gcmVxdWVzdGVkIHZhbHVlcwogKiAjIE9SIHRoZSBjbGFpbSBjb250YWlucyByZXF1ZXN0ZWQgdmFsdWVzIGFuZCB0aGUgdmFsdWUgZnJvbSB0aGUgdXNlcidzIHByb2ZpbGUgaXMgaW4gdGhlIGxpc3Qgb2YgdmFsdWVzCiAqCiAqIElmIG5vIG1hdGNoIGlzIGZvdW5kIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwoKbmFtZVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgeyAKICAgICAgICBkZWYgdmFsdWUgPSB0b0pzb24odXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICAvLyBAdG9kbyBuYW1lIGluY2x1ZGluZyBhbGwgbmFtZSBwYXJ0cywgcG9zc2libHkgaW5jbHVkaW5nIHRpdGxlcyBhbmQgc3VmZml4ZXMsIG9yZGVyZWQgYWNjb3JkaW5nIHRvIHRoZSBFbmQtVXNlcidzIGxvY2FsZSBhbmQgcHJlZmVyZW5jZXMuCiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgZ3Jvb3Z5Lmpzb24uaW50ZXJuYWwuTGF6eU1hcCkgewogICAgICAgICAgICBpZiAodmFsdWUuZ2l2ZW5OYW1lICYmIHZhbHVlLmZhbWlseU5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgImZhbWlseV9uYW1lIjogdmFsdWUuZmFtaWx5TmFtZSwKICAgICAgICAgICAgICAgICAgICAiZ2l2ZW5fbmFtZSI6IHZhbHVlLmdpdmVuTmFtZSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6ICIkdmFsdWUuZ2l2ZW5OYW1lICR2YWx1ZS5mYW1pbHlOYW1lIi50cmltKCksCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUuZmFtaWx5TmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAiZmFtaWx5X25hbWUiOiB2YWx1ZS5mYW1pbHlOYW1lLAogICAgICAgICAgICAgICAgICAgICJuYW1lIjogdmFsdWUuZmFtaWx5TmFtZSwKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5naXZlbk5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgImdpdmVuX25hbWUiOiB2YWx1ZS5naXZlbk5hbWUsCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZS5naXZlbk5hbWUsCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICJuYW1lIjogdmFsdWUsCiAgICAgICAgICAgIF0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZSwKICAgICAgICAgICAgXQogICAgICAgIH0KICAgIH0KICAgIFs6XQp9CgphdHRyaWJ1dGVSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBmaWVsZCwgdXNlUHJpbWFyeSwgYWRkVmVyaWZpZWQsIGNsYWltLCBpZGVudGl0eSAtPgogICAgbmFtZSA9IGNsYWltLmdldE5hbWUoKQogICAgdmFsdWUgPSBmcm9tU2V0KG5hbWUsIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKHZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHZhbHVlKSkpIHsgCiAgICAgICAgdmFsdWUgPSB0b0pzb24odmFsdWUpCiAgICAgICAgaWYgKHVzZVByaW1hcnkpIHsKICAgICAgICAgICAgdmFsdWUgPSBnZXRQcmltYXJ5T3JGaXJzdCh2YWx1ZSkKICAgICAgICB9CiAgICAgICAgaWYgKGFkZFZlcmlmaWVkKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAoIiR7bmFtZX1fdmVyaWZpZWQiKTogdmFsdWUudmVyaWZpZWQgPT0gdHJ1ZSA/IHRydWUgOiBmYWxzZSwKICAgICAgICAgICAgICAgIChuYW1lKTogZmllbGQgPyB2YWx1ZVtmaWVsZF0gOiB2YWx1ZSwKICAgICAgICAgICAgXQogICAgICAgIH0KICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAobmFtZSk6IGZpZWxkID8gdmFsdWVbZmllbGRdIDogdmFsdWUsCiAgICAgICAgXQogICAgfQogICAgWzpdCn0KCmJhc2ljUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICBuYW1lID0gY2xhaW0uZ2V0TmFtZSgpCiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChuYW1lLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgeyAKICAgICAgICBkZWYgdmFsdWUgPSB0b0pzb24odXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICB2YWx1ZSA9IGdldFByaW1hcnlPckZpcnN0KHZhbHVlKQogICAgICAgIHJldHVybiBbKG5hbWUpOiB2YWx1ZV0KICAgIH0KICAgIFs6XQp9CgpnZXRQcmltYXJ5T3JGaXJzdCA9IHsgdmFsdWUgLT4KICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGphdmEudXRpbC5BcnJheUxpc3QpIHsKICAgICAgICAvLyBsb29rIGZvciBwcmltYXJ5CiAgICAgICAgZm9yIChpdGVtIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpdGVtLnByaW1hcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpdGVtCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmV0dXJuIGZpcnN0CiAgICAgICAgcmV0dXJuIHZhbHVlWzBdCiAgICB9CiAgICByZXR1cm4gdmFsdWUKfQoKdG9Kc29uID0geyB2YWx1ZSAtPgogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgamF2YS51dGlsLkhhc2hTZXQpIHsKICAgICAgICBkZWYganNvblNldCA9IFtdCiAgICAgICAgdmFsdWUuZWFjaCB7IGkgLT4KICAgICAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgICAgICBqc29uU2V0LmFkZCh0b0pzb24oaSkpCiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAganNvblNldC5hZGQoaSkKICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGpzb25TZXQKICAgIH0KICAgIHRyeSB7IAogICAgICAgIHJldHVybiBuZXcgSnNvblNsdXJwZXIoKS5wYXJzZVRleHQodmFsdWUpCiAgICB9IGNhdGNoKGUpIHsKICAgICAgICByZXR1cm4gdmFsdWUKICAgIH0KfQoKCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gYnkgbG9va2luZyB1cCB0aGUgdXNlcidzIHByb2ZpbGUuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBmb3IgdGhlIGNsYWltIGlmOgogKiAjIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgaXMgbm90IG51bGwKICogIyBBTkQgdGhlIGNsYWltIGNvbnRhaW5zIG5vIHJlcXVlc3RlZCB2YWx1ZXMKICogIyBPUiB0aGUgY2xhaW0gY29udGFpbnMgcmVxdWVzdGVkIHZhbHVlcyBhbmQgdGhlIHZhbHVlIGZyb20gdGhlIHVzZXIncyBwcm9maWxlIGlzIGluIHRoZSBsaXN0IG9mIHZhbHVlcwogKgogKiBJZiB0aGUgY2xhaW0gaXMgZXNzZW50aWFsIGFuZCBubyB2YWx1ZSBpcyBmb3VuZCBhbiBJbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBhbmQgcmV0dXJuZWQgdG8gdGhlIHVzZXIuCiAqIElmIG5vIG1hdGNoIGlzIGZvdW5kIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwplc3NlbnRpYWxDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmIChjbGFpbS5pc0Vzc2VudGlhbCgpICYmICh1c2VyUHJvZmlsZVZhbHVlID09IG51bGwgfHwgdXNlclByb2ZpbGVWYWx1ZS5pc0VtcHR5KCkpKSB7CiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRSZXF1ZXN0RXhjZXB0aW9uKCJDb3VsZCBub3QgcHJvdmlkZSB2YWx1ZSBmb3IgZXNzZW50aWFsIGNsYWltICRjbGFpbSIpCiAgICB9CiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsKICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiB1c2VyUHJvZmlsZVZhbHVlXQogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gWzpdCiAgICB9Cn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIGV4cGVjdHMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSB2YWx1ZSB0byBiZSBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdDoKICogImxhbmd1YWdlX3RhZ3x2YWx1ZV9mb3JfbGFuZ3VhZ2UsLi4uIi4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHRha2UgdGhlIGxpc3Qgb2YgcmVxdWVzdGVkIGxhbmd1YWdlcyBmcm9tIHRoZSAnY2xhaW1zX2xvY2FsZXMnIGF1dGhvcml6ZSByZXF1ZXN0CiAqIHBhcmFtZXRlciBhbmQgYXR0ZW1wdCB0byBtYXRjaCBpdCB0byBhIHZhbHVlIGZyb20gdGhlIHVzZXJzJyBwcm9maWxlIGF0dHJpYnV0ZS4KICogSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmNsYWltTG9jYWxlc0NsYWltUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgIGxvY2FsZVZhbHVlcyA9IHBhcnNlTG9jYWxlQXdhcmVTdHJpbmcodXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICBsb2NhbGUgPSBjbGFpbXNMb2NhbGVzLmZpbmQgeyBsb2NhbGUgLT4gbG9jYWxlVmFsdWVzLmNvbnRhaW5zS2V5KGxvY2FsZSkgfQogICAgICAgIGlmIChsb2NhbGUgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBsb2NhbGVWYWx1ZXMuZ2V0KGxvY2FsZSldCiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIFs6XQp9CgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCBleHBlY3RzIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgdmFsdWUgdG8gYmUgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAqICJsYW5ndWFnZV90YWd8dmFsdWVfZm9yX2xhbmd1YWdlLC4uLiIuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCB0YWtlIHRoZSBsYW5ndWFnZSB0YWcgc3BlY2lmaWVkIGluIHRoZSBjbGFpbSBvYmplY3QgYW5kIGF0dGVtcHQgdG8gbWF0Y2ggaXQgdG8gYSB2YWx1ZQogKiBmcm9tIHRoZSB1c2VycycgcHJvZmlsZSBhdHRyaWJ1dGUuIElmIG5vIG1hdGNoIGlzIGZvdW5kIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwpsYW5ndWFnZVRhZ0NsYWltUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgIGxvY2FsZVZhbHVlcyA9IHBhcnNlTG9jYWxlQXdhcmVTdHJpbmcodXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICBpZiAoY2xhaW0uZ2V0TG9jYWxlKCkgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAobG9jYWxlVmFsdWVzLmNvbnRhaW5zS2V5KGNsYWltLmdldExvY2FsZSgpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogbG9jYWxlVmFsdWVzLmdldChjbGFpbS5nZXRMb2NhbGUoKSldCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbnRyeSA9IGxvY2FsZVZhbHVlcy5lbnRyeVNldCgpLml0ZXJhdG9yKCkubmV4dCgpCiAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkgKyAiIyIgKyBlbnRyeS5nZXRLZXkoKSk6IGVudHJ5LmdldFZhbHVlKCldCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbnRyeSA9IGxvY2FsZVZhbHVlcy5lbnRyeVNldCgpLml0ZXJhdG9yKCkubmV4dCgpCiAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IGVudHJ5LmdldFZhbHVlKCldCiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIFs6XQp9CgovKgogKiBHaXZlbiBhIHN0cmluZyAiZW58RW5nbGlzaCxqcHxKYXBlbmVzZSxmcl9DQXxGcmVuY2ggQ2FuYWRpYW4iIHdpbGwgcmV0dXJuIG1hcCBvZiBsb2NhbGUgLT4gdmFsdWUuCiAqLwpwYXJzZUxvY2FsZUF3YXJlU3RyaW5nID0geyBzIC0+CiAgICByZXR1cm4gcmVzdWx0ID0gcy5zcGxpdCgiLCIpLmNvbGxlY3RFbnRyaWVzIHsgZW50cnkgLT4KICAgICAgICBzcGxpdCA9IGVudHJ5LnNwbGl0KCJcXHwiKQogICAgICAgIFsoc3BsaXRbMF0pOiB2YWx1ZSA9IHNwbGl0WzFdXQogICAgfQp9Ci8vIC0tLV5eXl5eXl5eXl4tLS0gRVhBTVBMRSBDTEFJTSBBVFRSSUJVVEUgUkVTT0xWRVIgRlVOQ1RJT05TIC0tLV5eXl5eXl5eXl4tLS0KCi8vIC0tLS0tLS0tLS0tLS0tIFVQREFURSBUSElTIFRPIENIQU5HRSBDTEFJTSBUTyBBVFRSSUJVVEUgTUFQUElORyBGVU5DVElPTlMgLS0tLS0tLS0tLS0tLS0tCi8qCiAqIExpc3Qgb2YgY2xhaW0gcmVzb2x2ZXIgbWFwcGluZ3MuCiAqLwovLyBbIHtjbGFpbX06IHthdHRyaWJ1dGUgcmV0cmlldmVyfSwgLi4uIF0KY2xhaW1BdHRyaWJ1dGVzID0gWwogICAgICAgICJhZGRyZXNzIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1hZGRyZXNzZXMiLCBmYWxzZSwgdHJ1ZSwgZmFsc2UpLAogICAgICAgICJiaXJ0aGRhdGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tYmlydGhkYXRlIiksCiAgICAgICAgImVtYWlsIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1lbWFpbHMiLCAidmFsdWUiLCB0cnVlLCB0cnVlKSwKICAgICAgICAiZ2VuZGVyIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWdlbmRlciIpLAogICAgICAgICJsb2NhbGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tbG9jYWxlIiksCiAgICAgICAgIm5hbWUiOiBuYW1lUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1uYW1lIiksCiAgICAgICAgIm5pY2tuYW1lIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLW5pY2stbmFtZSIpLAogICAgICAgICJwaG9uZSI6IGF0dHJpYnV0ZVJlc29sdmVyLmN1cnJ5KCJmci1pZG0tcGhvbmUtbnVtYmVycyIsICJ2YWx1ZSIsIHRydWUsIHRydWUpLAogICAgICAgICJwaWN0dXJlIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1waG90b3MiLCAidmFsdWUiLCB0cnVlLCBmYWxzZSksCiAgICAgICAgInByZWZlcnJlZF91c2VybmFtZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoInVzZXJOYW1lIiksCiAgICAgICAgInByb2ZpbGVfdXJsIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLXByb2ZpbGUtdXJsIiksCiAgICAgICAgInRpdGxlIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLXRpdGxlIiksCiAgICAgICAgInVwZGF0ZWRfYXQiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tbGFzdENoYW5nZWQiKSwKICAgICAgICAidXNlcm5hbWUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJ1c2VyTmFtZSIpLAogICAgICAgICJ3ZWJzaXRlIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLXdlYnNpdGUiKSwKICAgICAgICAiem9uZWluZm8iOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tdGltZXpvbmUiKSwKXQoKLy8gLS0tLS0tLS0tLS0tLS0gVVBEQVRFIFRISVMgVE8gQ0hBTkdFIFNDT1BFIFRPIENMQUlNIE1BUFBJTkdTIC0tLS0tLS0tLS0tLS0tCi8qCiAqIE1hcCBvZiBzY29wZXMgdG8gY2xhaW0gb2JqZWN0cy4KICovCi8vIHtzY29wZX06IFsge2NsYWltfSwgLi4uIF0KLy8gaHR0cHM6Ly90cmVsbG8uY29tL2Mvd0hBM2VicDEvMTAyMS1pZC10b2tlbi1hbmQtdXNlcmluZm8tZW5kcG9pbnQtbm90LXJldHVybmluZy1hbGwtdXNlci1kYXRhCnNjb3BlQ2xhaW1zTWFwID0gWwogICAgICAgICJlbWFpbCI6IFsgImVtYWlsIiBdLAogICAgICAgICJhZGRyZXNzIjogWyAiYWRkcmVzcyIgXSwKICAgICAgICAicGhvbmUiOiBbICJwaG9uZSIgXSwKICAgICAgICAicHJvZmlsZSI6IFsgCiAgICAgICAgICAgICJiaXJ0aGRhdGUiLAogICAgICAgICAgICAiZ2VuZGVyIiwKICAgICAgICAgICAgImxvY2FsZSIsCiAgICAgICAgICAgICJuYW1lIiwgCiAgICAgICAgICAgICJuaWNrbmFtZSIsCiAgICAgICAgICAgICJwaWN0dXJlIiwKICAgICAgICAgICAgInByZWZlcnJlZF91c2VybmFtZSIsCiAgICAgICAgICAgICJwcm9maWxlX3VybCIsCiAgICAgICAgICAgICJ0aXRsZSIsIAogICAgICAgICAgICAidXBkYXRlZF9hdCIsCiAgICAgICAgICAgICJ1c2VybmFtZSIsCiAgICAgICAgICAgICJ3ZWJzaXRlIiwKICAgICAgICAgICAgInpvbmVpbmZvIiwgCiAgICAgICAgICAgIC8vICJhZGRyZXNzIiwKICAgICAgICBdCl0KCi8vIC0tLS0tLS0tLS0tLS0tLS0gVVBEQVRFIEJFTE9XIEZPUiBBRFZBTkNFRCBVU0FHRVMgLS0tLS0tLS0tLS0tLS0tLS0tLQppZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgIHNjb3Blcy5maW5kQWxsIHsgcyAtPiAhKCJvcGVuaWQiLmVxdWFscyhzKSB8fCBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzKSkgfS5lYWNoIHsgcyAtPgogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOjpNZXNzYWdlOiBzY29wZSBub3QgYm91bmQgdG8gY2xhaW1zOiAkcyIpCiAgICB9Cn0KCi8qCiAqIENvbXB1dGVzIHRoZSBjbGFpbXMgcmV0dXJuIGtleSBhbmQgdmFsdWUuIFRoZSBrZXkgbWF5IGJlIGEgZGlmZmVyZW50IHZhbHVlIGlmIHRoZSBjbGFpbSB2YWx1ZSBpcyBub3QgaW4KICogdGhlIHJlcXVlc3RlZCBsYW5ndWFnZS4KICovCmRlZiBjb21wdXRlQ2xhaW0gPSB7IGNsYWltIC0+CiAgICB0cnkgewogICAgICAgIGNsYWltUmVzb2x2ZXIgPSBjbGFpbUF0dHJpYnV0ZXMuZ2V0KGNsYWltLmdldE5hbWUoKSwgeyBjbGFpbU9iaiwgaWRlbnRpdHkgLT4gZGVmYXVsdENsYWltUmVzb2x2ZXIoY2xhaW0pfSkKICAgICAgICBjbGFpbVJlc29sdmVyKGNsYWltLCBpZGVudGl0eSkKICAgIH0gY2F0Y2ggKElkUmVwb0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgaWYgKGxvZ2dlci53YXJuaW5nRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBVbmFibGUgdG8gcmV0cmlldmUgYXR0cmlidXRlPSRhdHRyaWJ1dGUiLCBlKTsKICAgICAgICB9CiAgICB9IGNhdGNoIChTU09FeGNlcHRpb24gZSkgewogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogVW5hYmxlIHRvIHJldHJpZXZlIGF0dHJpYnV0ZT0kYXR0cmlidXRlIiwgZSk7CiAgICAgICAgfQogICAgfQp9CgovKgogKiBDb252ZXJ0cyByZXF1ZXN0ZWQgc2NvcGVzIGludG8gY2xhaW0gb2JqZWN0cyBiYXNlZCBvbiB0aGUgc2NvcGUgbWFwcGluZ3MgaW4gc2NvcGVDbGFpbXNNYXAuCiAqLwpkZWYgY29udmVydFNjb3BlVG9DbGFpbXMgPSB7CiAgICBzY29wZXMuZmluZEFsbCB7IHNjb3BlIC0+ICJvcGVuaWQiICE9IHNjb3BlICYmIHNjb3BlQ2xhaW1zTWFwLmNvbnRhaW5zS2V5KHNjb3BlKSB9LmNvbGxlY3RNYW55IHsgc2NvcGUgLT4KICAgICAgICBzY29wZUNsYWltc01hcC5nZXQoc2NvcGUpLmNvbGxlY3QgeyBjbGFpbSAtPgogICAgICAgICAgICBuZXcgQ2xhaW0oY2xhaW0pCiAgICAgICAgfQogICAgfQp9CgovLyBDcmVhdGVzIGEgZnVsbCBsaXN0IG9mIGNsYWltcyB0byByZXNvbHZlIGZyb20gcmVxdWVzdGVkIHNjb3BlcywgY2xhaW1zIHByb3ZpZGVkIGJ5IEFTIGFuZCByZXF1ZXN0ZWQgY2xhaW1zCmRlZiBjbGFpbXNUb1Jlc29sdmUgPSBjb252ZXJ0U2NvcGVUb0NsYWltcygpICsgY2xhaW1PYmplY3RzICsgcmVxdWVzdGVkVHlwZWRDbGFpbXMKCi8vIENvbXB1dGVzIHRoZSBjbGFpbSByZXR1cm4ga2V5IGFuZCB2YWx1ZXMgZm9yIGFsbCByZXF1ZXN0ZWQgY2xhaW1zCmNvbXB1dGVkQ2xhaW1zID0gY2xhaW1zVG9SZXNvbHZlLmNvbGxlY3RFbnRyaWVzKCkgeyBjbGFpbSAtPgogICAgcmVzdWx0ID0gY29tcHV0ZUNsYWltKGNsYWltKQp9CgovLyBDb21wdXRlcyBjb21wb3NpdGUgc2NvcGVzCmRlZiBjb21wb3NpdGVTY29wZXMgPSBzY29wZUNsYWltc01hcC5maW5kQWxsIHsgc2NvcGUgLT4KICAgIHNjb3Blcy5jb250YWlucyhzY29wZS5rZXkpCn0KCnJldHVybiBuZXcgVXNlckluZm9DbGFpbXMoKE1hcCljb21wdXRlZENsYWltcywgKE1hcCljb21wb3NpdGVTY29wZXMp",
    "default" : true,
    "language" : "GROOVY",
    "context" : "OIDC_CLAIMS",
    "createdBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "creationDate" : 1433147666269,
    "lastModifiedBy" : "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedDate" : 1433147666269
  }
}