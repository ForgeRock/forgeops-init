{
  "metadata": {
    "realm": "/",
    "amsterVersion": "&{version}",
    "entityType": "Scripts",
    "entityId": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "pathParams": {}
  },
  "data": {
    "_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "name": "OIDC Claims Script",
    "description": "Default global script for OIDC claims",
    "script": "LyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBGb3JnZVJvY2sgQVMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQKICoKICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4KICogb3Igd2l0aCBvbmUgb2YgaXRzIGFmZmlsaWF0ZXMuIEFsbCB1c2Ugc2hhbGwgYmUgZXhjbHVzaXZlbHkgc3ViamVjdAogKiB0byBzdWNoIGxpY2Vuc2UgYmV0d2VlbiB0aGUgbGljZW5zZWUgYW5kIEZvcmdlUm9jayBBUy4KICovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuZXhjZXB0aW9ucy5JbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbgppbXBvcnQgb3JnLmZvcmdlcm9jay5vYXV0aDIuY29yZS5Vc2VySW5mb0NsYWltcwppbXBvcnQgb3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0LkNsYWltCmltcG9ydCBncm9vdnkuanNvbi5Kc29uU2x1cnBlcgoKLyoKKiBEZWZpbmVkIHZhcmlhYmxlczoKKiBsb2dnZXIgLSBhbHdheXMgcHJlc2VudHMsIHRoZSAiT0F1dGgyUHJvdmlkZXIiIGRlYnVnIGxvZ2dlciBpbnN0YW5jZQoqIGNsYWltcyAtIGFsd2F5cyBwcmVzZW50LCBkZWZhdWx0IHNlcnZlciBwcm92aWRlZCBjbGFpbXMgLSBNYXA8U3RyaW5nLCBPYmplY3Q+CiogY2xhaW1PYmplY3RzIC0gYWx3YXlzIHByZXNlbnQsIGRlZmF1bHQgc2VydmVyIHByb3ZpZGVkIGNsYWltcyAtIExpc3Q8Q2xhaW0+Ciogc2Vzc2lvbiAtIHByZXNlbnQgaWYgdGhlIHJlcXVlc3QgY29udGFpbnMgdGhlIHNlc3Npb24gY29va2llLCB0aGUgdXNlcidzIHNlc3Npb24gb2JqZWN0CiogaWRlbnRpdHkgLSBhbHdheXMgcHJlc2VudCwgdGhlIGlkZW50aXR5IG9mIHRoZSByZXNvdXJjZSBvd25lcgoqIHNjb3BlcyAtIGFsd2F5cyBwcmVzZW50LCB0aGUgcmVxdWVzdGVkIHNjb3BlcwoqIHJlcXVlc3RlZENsYWltcyAtIE1hcDxTdHJpbmcsIFNldDxTdHJpbmc+PgoqICAgICAgICAgICAgICAgICAgYWx3YXlzIHByZXNlbnQsIG5vdCBlbXB0eSBpZiB0aGUgcmVxdWVzdCBjb250YWlucyBhIGNsYWltcyBwYXJhbWV0ZXIgYW5kIHNlcnZlciBoYXMgZW5hYmxlZAoqICAgICAgICAgICAgICAgICAgY2xhaW1zX3BhcmFtZXRlcl9zdXBwb3J0ZWQsIG1hcCBvZiByZXF1ZXN0ZWQgY2xhaW1zIHRvIHBvc3NpYmxlIHZhbHVlcywgb3RoZXJ3aXNlIGVtcHR5LAoqICAgICAgICAgICAgICAgICAgcmVxdWVzdGVkIGNsYWltcyB3aXRoIG5vIHJlcXVlc3RlZCB2YWx1ZXMgd2lsbCBoYXZlIGEga2V5IGJ1dCBubyB2YWx1ZSBpbiB0aGUgbWFwLiBBIGtleSB3aXRoCiogICAgICAgICAgICAgICAgICBhIHNpbmdsZSB2YWx1ZSBpbiBpdHMgU2V0IGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLgoqIHJlcXVlc3RlZFR5cGVkQ2xhaW1zIC0gTGlzdDxDbGFpbT4KKiAgICAgICAgICAgICAgICAgICAgICAgYWx3YXlzIHByZXNlbnQsIG5vdCBlbXB0eSBpZiB0aGUgcmVxdWVzdCBjb250YWlucyBhIGNsYWltcyBwYXJhbWV0ZXIgYW5kIHNlcnZlciBoYXMgZW5hYmxlZAoqICAgICAgICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1hdGVyX3N1cHBvcnRlZCwgbGlzdCBvZiByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggY2xhaW0gbmFtZSwgcmVxdWVzdGVkIHBvc3NpYmxlIHZhbHVlcwoqICAgICAgICAgICAgICAgICAgICAgICBhbmQgaWYgY2xhaW0gaXMgZXNzZW50aWFsLCBvdGhlcndpc2UgZW1wdHksCiogICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RlZCBjbGFpbXMgd2l0aCBubyByZXF1ZXN0ZWQgdmFsdWVzIHdpbGwgaGF2ZSBhIGNsYWltIHdpdGggbm8gdmFsdWVzLiBBIGNsYWltcyB3aXRoCiogICAgICAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLgoqIGNsYWltc0xvY2FsZXMgLSB0aGUgdmFsdWVzIGZyb20gdGhlICdjbGFpbXNfbG9jYWxlcycgcGFyYW1ldGVyIC0gTGlzdDxTdHJpbmc+CiogUmVxdWlyZWQgdG8gcmV0dXJuIGEgTWFwIG9mIGNsYWltcyB0byBiZSBhZGRlZCB0byB0aGUgaWRfdG9rZW4gY2xhaW1zCioKKiBFeHBlY3RlZCByZXR1cm4gdmFsdWUgc3RydWN0dXJlOgoqIFVzZXJJbmZvQ2xhaW1zIHsKKiAgICBNYXA8U3RyaW5nLCBPYmplY3Q+IHZhbHVlczsgLy8gVGhlIHZhbHVlcyBvZiB0aGUgY2xhaW1zIGZvciB0aGUgdXNlciBpbmZvcm1hdGlvbgoqICAgIE1hcDxTdHJpbmcsIExpc3Q8U3RyaW5nPj4gY29tcG9zaXRlU2NvcGVzOyAvLyBNYXBwaW5nIG9mIHNjb3BlIG5hbWUgdG8gYSBsaXN0IG9mIGNsYWltIG5hbWVzLgoqIH0KKi8KCi8vIHVzZXIgc2Vzc2lvbiBub3QgZ3VhcmFudGVlZCB0byBiZSBwcmVzZW50CmJvb2xlYW4gc2Vzc2lvblByZXNlbnQgPSBzZXNzaW9uICE9IG51bGwKCi8qCiAqIFB1bGxzIGZpcnN0IHZhbHVlIGZyb20gdXNlcnMgcHJvZmlsZSBhdHRyaWJ1dGUKICoKICogQHBhcmFtIGNsYWltIFRoZSBjbGFpbSBvYmplY3QuCiAqIEBwYXJhbSBhdHRyIFRoZSBwcm9maWxlIGF0dHJpYnV0ZSBuYW1lLgogKi8KZGVmIGZyb21TZXQgPSB7IGNsYWltLCBhdHRyIC0+CiAgICBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID09IDEpewogICAgICAgIGF0dHIuaXRlcmF0b3IoKS5uZXh0KCkKICAgIH0gZWxzZSBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID4gMSl7CiAgICAgICAgYXR0cgogICAgfSBlbHNlIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBHb3QgYW4gZW1wdHkgcmVzdWx0IGZvciBjbGFpbT0kY2xhaW0iKTsKICAgIH0KfQoKLy8gLS0tdnZ2dnZ2dnZ2di0tLSBFWEFNUExFIENMQUlNIEFUVFJJQlVURSBSRVNPTFZFUiBGVU5DVElPTlMgLS0tdnZ2dnZ2dnZ2di0tLQovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIGZyb20gaXRzIHJlcXVlc3RlZCB2YWx1ZXMuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBpZiB0aGUgY2xhaW0gaGFzIG9uZSByZXF1ZXN0ZWQgdmFsdWVzLCBvdGhlcndpc2UgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmRlZmF1bHRDbGFpbVJlc29sdmVyID0geyBjbGFpbSAtPgogICAgaWYgKGNsYWltLmdldFZhbHVlcygpLnNpemUoKSA9PSAxKSB7CiAgICAgICAgWyhjbGFpbS5nZXROYW1lKCkpOiBjbGFpbS5nZXRWYWx1ZXMoKS5pdGVyYXRvcigpLm5leHQoKV0KICAgIH0gZWxzZSB7CiAgICAgICAgWzpdCiAgICB9Cn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gYnkgbG9va2luZyB1cCB0aGUgdXNlcidzIHByb2ZpbGUuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBmb3IgdGhlIGNsYWltIGlmOgogKiAjIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgaXMgbm90IG51bGwKICogIyBBTkQgdGhlIGNsYWltIGNvbnRhaW5zIG5vIHJlcXVlc3RlZCB2YWx1ZXMKICogIyBPUiB0aGUgY2xhaW0gY29udGFpbnMgcmVxdWVzdGVkIHZhbHVlcyBhbmQgdGhlIHZhbHVlIGZyb20gdGhlIHVzZXIncyBwcm9maWxlIGlzIGluIHRoZSBsaXN0IG9mIHZhbHVlcwogKgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KCm5hbWVSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsgCiAgICAgICAgZGVmIHZhbHVlID0gdG9Kc29uKHVzZXJQcm9maWxlVmFsdWUpCiAgICAgICAgLy8gQHRvZG8gbmFtZSBpbmNsdWRpbmcgYWxsIG5hbWUgcGFydHMsIHBvc3NpYmx5IGluY2x1ZGluZyB0aXRsZXMgYW5kIHN1ZmZpeGVzLCBvcmRlcmVkIGFjY29yZGluZyB0byB0aGUgRW5kLVVzZXIncyBsb2NhbGUgYW5kIHByZWZlcmVuY2VzLgogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGdyb292eS5qc29uLmludGVybmFsLkxhenlNYXApIHsKICAgICAgICAgICAgaWYgKHZhbHVlLmdpdmVuTmFtZSAmJiB2YWx1ZS5mYW1pbHlOYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICJmYW1pbHlfbmFtZSI6IHZhbHVlLmZhbWlseU5hbWUsCiAgICAgICAgICAgICAgICAgICAgImdpdmVuX25hbWUiOiB2YWx1ZS5naXZlbk5hbWUsCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiAiJHZhbHVlLmdpdmVuTmFtZSAkdmFsdWUuZmFtaWx5TmFtZSIudHJpbSgpLAogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmZhbWlseU5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgImZhbWlseV9uYW1lIjogdmFsdWUuZmFtaWx5TmFtZSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHZhbHVlLmZhbWlseU5hbWUsCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUuZ2l2ZW5OYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICJnaXZlbl9uYW1lIjogdmFsdWUuZ2l2ZW5OYW1lLAogICAgICAgICAgICAgICAgICAgICJuYW1lIjogdmFsdWUuZ2l2ZW5OYW1lLAogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAibmFtZSI6IHZhbHVlLAogICAgICAgICAgICBdCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICJuYW1lIjogdmFsdWUsCiAgICAgICAgICAgIF0KICAgICAgICB9CiAgICB9CiAgICBbOl0KfQoKYXR0cmlidXRlUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgZmllbGQsIHVzZVByaW1hcnksIGFkZFZlcmlmaWVkLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIG5hbWUgPSBjbGFpbS5nZXROYW1lKCkKICAgIGxvZ2dlci5tZXNzYWdlKCJhdHRyaWJ1dGVSZXNvbHZlcjogIiArIG5hbWUpCiAgICB2YWx1ZSA9IGZyb21TZXQobmFtZSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAoY2xhaW0uZ2V0VmFsdWVzKCkgPT0gbnVsbCB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5pc0VtcHR5KCkgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuY29udGFpbnModmFsdWUpKSkgeyAKICAgICAgICB2YWx1ZSA9IHRvSnNvbih2YWx1ZSkKICAgICAgICBpZiAodXNlUHJpbWFyeSkgewogICAgICAgICAgICB2YWx1ZSA9IGdldFByaW1hcnlPckZpcnN0KHZhbHVlKQogICAgICAgIH0KICAgICAgICBpZiAoYWRkVmVyaWZpZWQpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICgiJHtuYW1lfV92ZXJpZmllZCIpOiB2YWx1ZS5oYXNQcm9wZXJ0eSgidmVyaWZpZWQiKSAmJiB2YWx1ZS52ZXJpZmllZCA9PSB0cnVlID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgKG5hbWUpOiBmaWVsZCAmJiB2YWx1ZS5oYXNQcm9wZXJ0eShmaWVsZCkgPyB2YWx1ZVtmaWVsZF0gOiB2YWx1ZSwKICAgICAgICAgICAgXQogICAgICAgIH0KICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAobmFtZSk6IGZpZWxkID8gdmFsdWVbZmllbGRdIDogdmFsdWUsCiAgICAgICAgXQogICAgfQogICAgWzpdCn0KCmJhc2ljUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICBuYW1lID0gY2xhaW0uZ2V0TmFtZSgpCiAgICBsb2dnZXIubWVzc2FnZSgiYmFzaWNSZXNvbHZlcjogIiArIG5hbWUpCiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChuYW1lLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgeyAKICAgICAgICBkZWYgdmFsdWUgPSB0b0pzb24odXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICB2YWx1ZSA9IGdldFByaW1hcnlPckZpcnN0KHZhbHVlKQogICAgICAgIHJldHVybiBbKG5hbWUpOiB2YWx1ZV0KICAgIH0KICAgIFs6XQp9CgpnZXRQcmltYXJ5T3JGaXJzdCA9IHsgdmFsdWUgLT4KICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGphdmEudXRpbC5BcnJheUxpc3QpIHsKICAgICAgICAvLyBsb29rIGZvciBwcmltYXJ5CiAgICAgICAgZm9yIChpdGVtIGluIHZhbHVlKSB7CiAgICAgICAgICAJb2JqID0gdG9Kc29uKGl0ZW0pCiAgICAgICAgICAgIGlmIChvYmouaGFzUHJvcGVydHkoInByaW1hcnkiKSAmJiBvYmoucHJpbWFyeSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmV0dXJuIGZpcnN0CiAgICAgICAgcmV0dXJuIHRvSnNvbih2YWx1ZVswXSkKICAgIH0KICAgIHJldHVybiB2YWx1ZQp9Cgp0b0pzb24gPSB7IHZhbHVlIC0+CiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBqYXZhLnV0aWwuSGFzaFNldCkgewogICAgICAgIGRlZiBqc29uU2V0ID0gW10KICAgICAgICB2YWx1ZS5lYWNoIHsgaSAtPgogICAgICAgICAgICB0cnkgeyAKICAgICAgICAgICAgICAgIGpzb25TZXQuYWRkKHRvSnNvbihpKSkKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICBqc29uU2V0LmFkZChpKQogICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgfTsKICAgICAgICByZXR1cm4ganNvblNldAogICAgfQogICAgdHJ5IHsgCiAgICAgICAgcmV0dXJuIG5ldyBKc29uU2x1cnBlcigpLnBhcnNlVGV4dCh2YWx1ZSkKICAgIH0gY2F0Y2goZSkgewogICAgICAgIHJldHVybiB2YWx1ZQogICAgfQp9CgoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggcmVzb2x2ZXMgdGhlIHZhbHVlIG9mIHRoZSBjbGFpbSBieSBsb29raW5nIHVwIHRoZSB1c2VyJ3MgcHJvZmlsZS4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHJldHVybiBhIHZhbHVlIGZvciB0aGUgY2xhaW0gaWY6CiAqICMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSBpcyBub3QgbnVsbAogKiAjIEFORCB0aGUgY2xhaW0gY29udGFpbnMgbm8gcmVxdWVzdGVkIHZhbHVlcwogKiAjIE9SIHRoZSBjbGFpbSBjb250YWlucyByZXF1ZXN0ZWQgdmFsdWVzIGFuZCB0aGUgdmFsdWUgZnJvbSB0aGUgdXNlcidzIHByb2ZpbGUgaXMgaW4gdGhlIGxpc3Qgb2YgdmFsdWVzCiAqCiAqIElmIHRoZSBjbGFpbSBpcyBlc3NlbnRpYWwgYW5kIG5vIHZhbHVlIGlzIGZvdW5kIGFuIEludmFsaWRSZXF1ZXN0RXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGFuZCByZXR1cm5lZCB0byB0aGUgdXNlci4KICogSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmVzc2VudGlhbENsYWltUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKGNsYWltLmlzRXNzZW50aWFsKCkgJiYgKHVzZXJQcm9maWxlVmFsdWUgPT0gbnVsbCB8fCB1c2VyUHJvZmlsZVZhbHVlLmlzRW1wdHkoKSkpIHsKICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFJlcXVlc3RFeGNlcHRpb24oIkNvdWxkIG5vdCBwcm92aWRlIHZhbHVlIGZvciBlc3NlbnRpYWwgY2xhaW0gJGNsYWltIikKICAgIH0KICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgewogICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IHVzZXJQcm9maWxlVmFsdWVdCiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBbOl0KICAgIH0KfQoKLyoKICogQ2xhaW0gcmVzb2x2ZXIgd2hpY2ggZXhwZWN0cyB0aGUgdXNlcidzIHByb2ZpbGUgYXR0cmlidXRlIHZhbHVlIHRvIGJlIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OgogKiAibGFuZ3VhZ2VfdGFnfHZhbHVlX2Zvcl9sYW5ndWFnZSwuLi4iLgogKgogKiBUaGlzIHJlc29sdmVyIHdpbGwgdGFrZSB0aGUgbGlzdCBvZiByZXF1ZXN0ZWQgbGFuZ3VhZ2VzIGZyb20gdGhlICdjbGFpbXNfbG9jYWxlcycgYXV0aG9yaXplIHJlcXVlc3QKICogcGFyYW1ldGVyIGFuZCBhdHRlbXB0IHRvIG1hdGNoIGl0IHRvIGEgdmFsdWUgZnJvbSB0aGUgdXNlcnMnIHByb2ZpbGUgYXR0cmlidXRlLgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KY2xhaW1Mb2NhbGVzQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgbG9jYWxlVmFsdWVzID0gcGFyc2VMb2NhbGVBd2FyZVN0cmluZyh1c2VyUHJvZmlsZVZhbHVlKQogICAgICAgIGxvY2FsZSA9IGNsYWltc0xvY2FsZXMuZmluZCB7IGxvY2FsZSAtPiBsb2NhbGVWYWx1ZXMuY29udGFpbnNLZXkobG9jYWxlKSB9CiAgICAgICAgaWYgKGxvY2FsZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IGxvY2FsZVZhbHVlcy5nZXQobG9jYWxlKV0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gWzpdCn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIGV4cGVjdHMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSB2YWx1ZSB0byBiZSBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdDoKICogImxhbmd1YWdlX3RhZ3x2YWx1ZV9mb3JfbGFuZ3VhZ2UsLi4uIi4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHRha2UgdGhlIGxhbmd1YWdlIHRhZyBzcGVjaWZpZWQgaW4gdGhlIGNsYWltIG9iamVjdCBhbmQgYXR0ZW1wdCB0byBtYXRjaCBpdCB0byBhIHZhbHVlCiAqIGZyb20gdGhlIHVzZXJzJyBwcm9maWxlIGF0dHJpYnV0ZS4gSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmxhbmd1YWdlVGFnQ2xhaW1SZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgbG9jYWxlVmFsdWVzID0gcGFyc2VMb2NhbGVBd2FyZVN0cmluZyh1c2VyUHJvZmlsZVZhbHVlKQogICAgICAgIGlmIChjbGFpbS5nZXRMb2NhbGUoKSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChsb2NhbGVWYWx1ZXMuY29udGFpbnNLZXkoY2xhaW0uZ2V0TG9jYWxlKCkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBsb2NhbGVWYWx1ZXMuZ2V0KGNsYWltLmdldExvY2FsZSgpKV0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVudHJ5ID0gbG9jYWxlVmFsdWVzLmVudHJ5U2V0KCkuaXRlcmF0b3IoKS5uZXh0KCkKICAgICAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSArICIjIiArIGVudHJ5LmdldEtleSgpKTogZW50cnkuZ2V0VmFsdWUoKV0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVudHJ5ID0gbG9jYWxlVmFsdWVzLmVudHJ5U2V0KCkuaXRlcmF0b3IoKS5uZXh0KCkKICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogZW50cnkuZ2V0VmFsdWUoKV0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gWzpdCn0KCi8qCiAqIEdpdmVuIGEgc3RyaW5nICJlbnxFbmdsaXNoLGpwfEphcGVuZXNlLGZyX0NBfEZyZW5jaCBDYW5hZGlhbiIgd2lsbCByZXR1cm4gbWFwIG9mIGxvY2FsZSAtPiB2YWx1ZS4KICovCnBhcnNlTG9jYWxlQXdhcmVTdHJpbmcgPSB7IHMgLT4KICAgIHJldHVybiByZXN1bHQgPSBzLnNwbGl0KCIsIikuY29sbGVjdEVudHJpZXMgeyBlbnRyeSAtPgogICAgICAgIHNwbGl0ID0gZW50cnkuc3BsaXQoIlxcfCIpCiAgICAgICAgWyhzcGxpdFswXSk6IHZhbHVlID0gc3BsaXRbMV1dCiAgICB9Cn0KLy8gLS0tXl5eXl5eXl5eXi0tLSBFWEFNUExFIENMQUlNIEFUVFJJQlVURSBSRVNPTFZFUiBGVU5DVElPTlMgLS0tXl5eXl5eXl5eXi0tLQoKLy8gLS0tLS0tLS0tLS0tLS0gVVBEQVRFIFRISVMgVE8gQ0hBTkdFIENMQUlNIFRPIEFUVFJJQlVURSBNQVBQSU5HIEZVTkNUSU9OUyAtLS0tLS0tLS0tLS0tLS0KLyoKICogTGlzdCBvZiBjbGFpbSByZXNvbHZlciBtYXBwaW5ncy4KICovCi8vIFsge2NsYWltfToge2F0dHJpYnV0ZSByZXRyaWV2ZXJ9LCAuLi4gXQpjbGFpbUF0dHJpYnV0ZXMgPSBbCiAgICAgICAgImFkZHJlc3MiOiBhdHRyaWJ1dGVSZXNvbHZlci5jdXJyeSgiZnItaWRtLWFkZHJlc3NlcyIsIGZhbHNlLCB0cnVlLCBmYWxzZSksCiAgICAgICAgImJpcnRoZGF0ZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1iaXJ0aGRhdGUiKSwKICAgICAgICAiZW1haWwiOiBhdHRyaWJ1dGVSZXNvbHZlci5jdXJyeSgiZnItaWRtLWVtYWlscyIsICJ2YWx1ZSIsIHRydWUsIHRydWUpLAogICAgICAgICJnZW5kZXIiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tZ2VuZGVyIiksCiAgICAgICAgImxvY2FsZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1sb2NhbGUiKSwKICAgICAgICAibmFtZSI6IG5hbWVSZXNvbHZlci5jdXJyeSgiZnItaWRtLW5hbWUtb2JqZWN0IiksCiAgICAgICAgIm5pY2tuYW1lIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLW5pY2stbmFtZSIpLAogICAgICAgICJwaG9uZSI6IGF0dHJpYnV0ZVJlc29sdmVyLmN1cnJ5KCJmci1pZG0tcGhvbmUtbnVtYmVycyIsICJ2YWx1ZSIsIHRydWUsIGZhbHNlKSwKICAgICAgICAicGljdHVyZSI6IGF0dHJpYnV0ZVJlc29sdmVyLmN1cnJ5KCJmci1pZG0tcGhvdG9zIiwgInZhbHVlIiwgdHJ1ZSwgZmFsc2UpLAogICAgICAgICJwcmVmZXJyZWRfdXNlcm5hbWUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJ1c2VyTmFtZSIpLAogICAgICAgICJwcm9maWxlX3VybCI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1wcm9maWxlLXVybCIpLAogICAgICAgICJ0aXRsZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS10aXRsZSIpLAogICAgICAgICJ1cGRhdGVkX2F0IjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWxhc3RDaGFuZ2VkIiksCiAgICAgICAgInVzZXJuYW1lIjogYmFzaWNSZXNvbHZlci5jdXJyeSgidXNlck5hbWUiKSwKICAgICAgICAid2Vic2l0ZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS13ZWJzaXRlIiksCiAgICAgICAgInpvbmVpbmZvIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLXRpbWV6b25lIiksCl0KCi8vIC0tLS0tLS0tLS0tLS0tIFVQREFURSBUSElTIFRPIENIQU5HRSBTQ09QRSBUTyBDTEFJTSBNQVBQSU5HUyAtLS0tLS0tLS0tLS0tLQovKgogKiBNYXAgb2Ygc2NvcGVzIHRvIGNsYWltIG9iamVjdHMuCiAqLwovLyB7c2NvcGV9OiBbIHtjbGFpbX0sIC4uLiBdCi8vIGh0dHBzOi8vdHJlbGxvLmNvbS9jL3dIQTNlYnAxLzEwMjEtaWQtdG9rZW4tYW5kLXVzZXJpbmZvLWVuZHBvaW50LW5vdC1yZXR1cm5pbmctYWxsLXVzZXItZGF0YQpzY29wZUNsYWltc01hcCA9IFsKICAgICAgICAiZW1haWwiOiBbICJlbWFpbCIgXSwKICAgICAgICAiYWRkcmVzcyI6IFsgImFkZHJlc3MiIF0sCiAgICAgICAgInBob25lIjogWyAicGhvbmUiIF0sCiAgICAgICAgInByb2ZpbGUiOiBbIAogICAgICAgICAgICAiYmlydGhkYXRlIiwKICAgICAgICAgICAgImZhbWlseV9uYW1lIiwKICAgICAgICAgICAgImdlbmRlciIsCiAgICAgICAgICAgICJnaXZlbl9uYW1lIiwKICAgICAgICAgICAgImxvY2FsZSIsCiAgICAgICAgICAgICJuYW1lIiwgCiAgICAgICAgICAgICJuaWNrbmFtZSIsCiAgICAgICAgICAgICJwaWN0dXJlIiwKICAgICAgICAgICAgInByZWZlcnJlZF91c2VybmFtZSIsCiAgICAgICAgICAgICJwcm9maWxlX3VybCIsCiAgICAgICAgICAgICJ0aXRsZSIsIAogICAgICAgICAgICAidXBkYXRlZF9hdCIsCiAgICAgICAgICAgICJ1c2VybmFtZSIsCiAgICAgICAgICAgICJ3ZWJzaXRlIiwKICAgICAgICAgICAgInpvbmVpbmZvIiwKICAgICAgICBdCl0KCi8vIC0tLS0tLS0tLS0tLS0tLS0gVVBEQVRFIEJFTE9XIEZPUiBBRFZBTkNFRCBVU0FHRVMgLS0tLS0tLS0tLS0tLS0tLS0tLQppZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgIHNjb3Blcy5maW5kQWxsIHsgcyAtPiAhKCJvcGVuaWQiLmVxdWFscyhzKSB8fCBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzKSkgfS5lYWNoIHsgcyAtPgogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOjpNZXNzYWdlOiBzY29wZSBub3QgYm91bmQgdG8gY2xhaW1zOiAkcyIpCiAgICB9Cn0KCi8qCiAqIENvbXB1dGVzIHRoZSBjbGFpbXMgcmV0dXJuIGtleSBhbmQgdmFsdWUuIFRoZSBrZXkgbWF5IGJlIGEgZGlmZmVyZW50IHZhbHVlIGlmIHRoZSBjbGFpbSB2YWx1ZSBpcyBub3QgaW4KICogdGhlIHJlcXVlc3RlZCBsYW5ndWFnZS4KICovCmRlZiBjb21wdXRlQ2xhaW0gPSB7IGNsYWltIC0+CiAgICB0cnkgewogICAgICAgIGNsYWltUmVzb2x2ZXIgPSBjbGFpbUF0dHJpYnV0ZXMuZ2V0KGNsYWltLmdldE5hbWUoKSwgeyBjbGFpbU9iaiwgaWRlbnRpdHkgLT4gZGVmYXVsdENsYWltUmVzb2x2ZXIoY2xhaW0pfSkKICAgICAgICBjbGFpbVJlc29sdmVyKGNsYWltLCBpZGVudGl0eSkKICAgIH0gY2F0Y2ggKElkUmVwb0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgaWYgKGxvZ2dlci53YXJuaW5nRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBVbmFibGUgdG8gcmV0cmlldmUgYXR0cmlidXRlPSRhdHRyaWJ1dGUiLCBlKTsKICAgICAgICB9CiAgICB9IGNhdGNoIChTU09FeGNlcHRpb24gZSkgewogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogVW5hYmxlIHRvIHJldHJpZXZlIGF0dHJpYnV0ZT0kYXR0cmlidXRlIiwgZSk7CiAgICAgICAgfQogICAgfQp9CgovKgogKiBDb252ZXJ0cyByZXF1ZXN0ZWQgc2NvcGVzIGludG8gY2xhaW0gb2JqZWN0cyBiYXNlZCBvbiB0aGUgc2NvcGUgbWFwcGluZ3MgaW4gc2NvcGVDbGFpbXNNYXAuCiAqLwpkZWYgY29udmVydFNjb3BlVG9DbGFpbXMgPSB7CiAgICBzY29wZXMuZmluZEFsbCB7IHNjb3BlIC0+ICJvcGVuaWQiICE9IHNjb3BlICYmIHNjb3BlQ2xhaW1zTWFwLmNvbnRhaW5zS2V5KHNjb3BlKSB9LmNvbGxlY3RNYW55IHsgc2NvcGUgLT4KICAgICAgICBzY29wZUNsYWltc01hcC5nZXQoc2NvcGUpLmNvbGxlY3QgeyBjbGFpbSAtPgogICAgICAgICAgICBuZXcgQ2xhaW0oY2xhaW0pCiAgICAgICAgfQogICAgfQp9CgovLyBDcmVhdGVzIGEgZnVsbCBsaXN0IG9mIGNsYWltcyB0byByZXNvbHZlIGZyb20gcmVxdWVzdGVkIHNjb3BlcywgY2xhaW1zIHByb3ZpZGVkIGJ5IEFTIGFuZCByZXF1ZXN0ZWQgY2xhaW1zCmRlZiBjbGFpbXNUb1Jlc29sdmUgPSBjb252ZXJ0U2NvcGVUb0NsYWltcygpICsgY2xhaW1PYmplY3RzICsgcmVxdWVzdGVkVHlwZWRDbGFpbXMKCi8vIENvbXB1dGVzIHRoZSBjbGFpbSByZXR1cm4ga2V5IGFuZCB2YWx1ZXMgZm9yIGFsbCByZXF1ZXN0ZWQgY2xhaW1zCmNvbXB1dGVkQ2xhaW1zID0gY2xhaW1zVG9SZXNvbHZlLmNvbGxlY3RFbnRyaWVzKCkgeyBjbGFpbSAtPgogICAgY29tcHV0ZUNsYWltKGNsYWltKQp9CgovLyBDb21wdXRlcyBjb21wb3NpdGUgc2NvcGVzCmRlZiBjb21wb3NpdGVTY29wZXMgPSBzY29wZUNsYWltc01hcC5maW5kQWxsIHsgc2NvcGUgLT4KICAgIHNjb3Blcy5jb250YWlucyhzY29wZS5rZXkpCn0KCnJldHVybiBuZXcgVXNlckluZm9DbGFpbXMoKE1hcCljb21wdXRlZENsYWltcywgKE1hcCljb21wb3NpdGVTY29wZXMpCg==",
    "default": true,
    "language": "GROOVY",
    "context": "OIDC_CLAIMS",
    "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "creationDate": 1433147666269,
    "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedDate": 1433147666269
  }
}
