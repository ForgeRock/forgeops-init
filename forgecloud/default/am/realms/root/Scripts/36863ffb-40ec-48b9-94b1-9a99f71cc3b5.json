{
  "metadata": {
    "realm": "/",
    "amsterVersion": "&{version}",
    "entityType": "Scripts",
    "entityId": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "pathParams": {}
  },
  "data": {
    "_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
    "name": "OIDC Claims Script",
    "description": "Default global script for OIDC claims",
    "script": "LyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBGb3JnZVJvY2sgQVMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQKICoKICogVXNlIG9mIHRoaXMgY29kZSByZXF1aXJlcyBhIGNvbW1lcmNpYWwgc29mdHdhcmUgbGljZW5zZSB3aXRoIEZvcmdlUm9jayBBUy4KICogb3Igd2l0aCBvbmUgb2YgaXRzIGFmZmlsaWF0ZXMuIEFsbCB1c2Ugc2hhbGwgYmUgZXhjbHVzaXZlbHkgc3ViamVjdAogKiB0byBzdWNoIGxpY2Vuc2UgYmV0d2VlbiB0aGUgbGljZW5zZWUgYW5kIEZvcmdlUm9jayBBUy4KICovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KaW1wb3J0IG9yZy5mb3JnZXJvY2sub2F1dGgyLmNvcmUuZXhjZXB0aW9ucy5JbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbgppbXBvcnQgb3JnLmZvcmdlcm9jay5vYXV0aDIuY29yZS5Vc2VySW5mb0NsYWltcwppbXBvcnQgb3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0LkNsYWltCmltcG9ydCBncm9vdnkuanNvbi5Kc29uU2x1cnBlcgppbXBvcnQgZ3Jvb3Z5Lmpzb24uaW50ZXJuYWwuTGF6eU1hcAoKLyoKKiBEZWZpbmVkIHZhcmlhYmxlczoKKiBsb2dnZXIgLSBhbHdheXMgcHJlc2VudHMsIHRoZSAiT0F1dGgyUHJvdmlkZXIiIGRlYnVnIGxvZ2dlciBpbnN0YW5jZQoqIGNsYWltcyAtIGFsd2F5cyBwcmVzZW50LCBkZWZhdWx0IHNlcnZlciBwcm92aWRlZCBjbGFpbXMgLSBNYXA8U3RyaW5nLCBPYmplY3Q+CiogY2xhaW1PYmplY3RzIC0gYWx3YXlzIHByZXNlbnQsIGRlZmF1bHQgc2VydmVyIHByb3ZpZGVkIGNsYWltcyAtIExpc3Q8Q2xhaW0+Ciogc2Vzc2lvbiAtIHByZXNlbnQgaWYgdGhlIHJlcXVlc3QgY29udGFpbnMgdGhlIHNlc3Npb24gY29va2llLCB0aGUgdXNlcidzIHNlc3Npb24gb2JqZWN0CiogaWRlbnRpdHkgLSBhbHdheXMgcHJlc2VudCwgdGhlIGlkZW50aXR5IG9mIHRoZSByZXNvdXJjZSBvd25lcgoqIHNjb3BlcyAtIGFsd2F5cyBwcmVzZW50LCB0aGUgcmVxdWVzdGVkIHNjb3BlcwoqIHJlcXVlc3RlZENsYWltcyAtIE1hcDxTdHJpbmcsIFNldDxTdHJpbmc+PgoqICAgICAgICAgICAgICAgICAgYWx3YXlzIHByZXNlbnQsIG5vdCBlbXB0eSBpZiB0aGUgcmVxdWVzdCBjb250YWlucyBhIGNsYWltcyBwYXJhbWV0ZXIgYW5kIHNlcnZlciBoYXMgZW5hYmxlZAoqICAgICAgICAgICAgICAgICAgY2xhaW1zX3BhcmFtZXRlcl9zdXBwb3J0ZWQsIG1hcCBvZiByZXF1ZXN0ZWQgY2xhaW1zIHRvIHBvc3NpYmxlIHZhbHVlcywgb3RoZXJ3aXNlIGVtcHR5LAoqICAgICAgICAgICAgICAgICAgcmVxdWVzdGVkIGNsYWltcyB3aXRoIG5vIHJlcXVlc3RlZCB2YWx1ZXMgd2lsbCBoYXZlIGEga2V5IGJ1dCBubyB2YWx1ZSBpbiB0aGUgbWFwLiBBIGtleSB3aXRoCiogICAgICAgICAgICAgICAgICBhIHNpbmdsZSB2YWx1ZSBpbiBpdHMgU2V0IGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLgoqIHJlcXVlc3RlZFR5cGVkQ2xhaW1zIC0gTGlzdDxDbGFpbT4KKiAgICAgICAgICAgICAgICAgICAgICAgYWx3YXlzIHByZXNlbnQsIG5vdCBlbXB0eSBpZiB0aGUgcmVxdWVzdCBjb250YWlucyBhIGNsYWltcyBwYXJhbWV0ZXIgYW5kIHNlcnZlciBoYXMgZW5hYmxlZAoqICAgICAgICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1hdGVyX3N1cHBvcnRlZCwgbGlzdCBvZiByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggY2xhaW0gbmFtZSwgcmVxdWVzdGVkIHBvc3NpYmxlIHZhbHVlcwoqICAgICAgICAgICAgICAgICAgICAgICBhbmQgaWYgY2xhaW0gaXMgZXNzZW50aWFsLCBvdGhlcndpc2UgZW1wdHksCiogICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RlZCBjbGFpbXMgd2l0aCBubyByZXF1ZXN0ZWQgdmFsdWVzIHdpbGwgaGF2ZSBhIGNsYWltIHdpdGggbm8gdmFsdWVzLiBBIGNsYWltcyB3aXRoCiogICAgICAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluZGljYXRlcyB0aGlzIGlzIHRoZSBvbmx5IHZhbHVlIHRoYXQgc2hvdWxkIGJlIHJldHVybmVkLgoqIGNsYWltc0xvY2FsZXMgLSB0aGUgdmFsdWVzIGZyb20gdGhlICdjbGFpbXNfbG9jYWxlcycgcGFyYW1ldGVyIC0gTGlzdDxTdHJpbmc+CiogUmVxdWlyZWQgdG8gcmV0dXJuIGEgTWFwIG9mIGNsYWltcyB0byBiZSBhZGRlZCB0byB0aGUgaWRfdG9rZW4gY2xhaW1zCioKKiBFeHBlY3RlZCByZXR1cm4gdmFsdWUgc3RydWN0dXJlOgoqIFVzZXJJbmZvQ2xhaW1zIHsKKiAgICBNYXA8U3RyaW5nLCBPYmplY3Q+IHZhbHVlczsgLy8gVGhlIHZhbHVlcyBvZiB0aGUgY2xhaW1zIGZvciB0aGUgdXNlciBpbmZvcm1hdGlvbgoqICAgIE1hcDxTdHJpbmcsIExpc3Q8U3RyaW5nPj4gY29tcG9zaXRlU2NvcGVzOyAvLyBNYXBwaW5nIG9mIHNjb3BlIG5hbWUgdG8gYSBsaXN0IG9mIGNsYWltIG5hbWVzLgoqIH0KKi8KCi8vIHVzZXIgc2Vzc2lvbiBub3QgZ3VhcmFudGVlZCB0byBiZSBwcmVzZW50CmJvb2xlYW4gc2Vzc2lvblByZXNlbnQgPSBzZXNzaW9uICE9IG51bGwKCi8qCiAqIFB1bGxzIGZpcnN0IHZhbHVlIGZyb20gdXNlcnMgcHJvZmlsZSBhdHRyaWJ1dGUKICoKICogQHBhcmFtIGNsYWltIFRoZSBjbGFpbSBvYmplY3QuCiAqIEBwYXJhbSBhdHRyIFRoZSBwcm9maWxlIGF0dHJpYnV0ZSBuYW1lLgogKi8KZGVmIGZyb21TZXQgPSB7IGNsYWltLCBhdHRyIC0+CiAgICBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID09IDEpewogICAgICAgIGF0dHIuaXRlcmF0b3IoKS5uZXh0KCkKICAgIH0gZWxzZSBpZiAoYXR0ciAhPSBudWxsICYmIGF0dHIuc2l6ZSgpID4gMSl7CiAgICAgICAgYXR0cgogICAgfSBlbHNlIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBHb3QgYW4gZW1wdHkgcmVzdWx0IGZvciBjbGFpbT0kY2xhaW0iKTsKICAgIH0KfQoKLy8gLS0tdnZ2dnZ2dnZ2di0tLSBFWEFNUExFIENMQUlNIEFUVFJJQlVURSBSRVNPTFZFUiBGVU5DVElPTlMgLS0tdnZ2dnZ2dnZ2di0tLQovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCByZXNvbHZlcyB0aGUgdmFsdWUgb2YgdGhlIGNsYWltIGZyb20gaXRzIHJlcXVlc3RlZCB2YWx1ZXMuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBpZiB0aGUgY2xhaW0gaGFzIG9uZSByZXF1ZXN0ZWQgdmFsdWVzLCBvdGhlcndpc2UgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmRlZmF1bHRDbGFpbVJlc29sdmVyID0geyBjbGFpbSAtPgogICAgaWYgKGNsYWltLmdldFZhbHVlcygpLnNpemUoKSA9PSAxKSB7CiAgICAgICAgWyhjbGFpbS5nZXROYW1lKCkpOiBjbGFpbS5nZXRWYWx1ZXMoKS5pdGVyYXRvcigpLm5leHQoKV0KICAgIH0gZWxzZSB7CiAgICAgICAgWzpdCiAgICB9Cn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gYnkgbG9va2luZyB1cCB0aGUgdXNlcidzIHByb2ZpbGUuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBmb3IgdGhlIGNsYWltIGlmOgogKiAjIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgaXMgbm90IG51bGwKICogIyBBTkQgdGhlIGNsYWltIGNvbnRhaW5zIG5vIHJlcXVlc3RlZCB2YWx1ZXMKICogIyBPUiB0aGUgY2xhaW0gY29udGFpbnMgcmVxdWVzdGVkIHZhbHVlcyBhbmQgdGhlIHZhbHVlIGZyb20gdGhlIHVzZXIncyBwcm9maWxlIGlzIGluIHRoZSBsaXN0IG9mIHZhbHVlcwogKgogKiBJZiBubyBtYXRjaCBpcyBmb3VuZCBhbiBleGNlcHRpb24gaXMgdGhyb3duLgogKi8KCm5hbWVSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KGNsYWltLmdldE5hbWUoKSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsKICAgICAgICBkZWYgdmFsdWUgPSB0b0pzb24odXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICAvLyBAdG9kbyBuYW1lIGluY2x1ZGluZyBhbGwgbmFtZSBwYXJ0cywgcG9zc2libHkgaW5jbHVkaW5nIHRpdGxlcyBhbmQgc3VmZml4ZXMsIG9yZGVyZWQgYWNjb3JkaW5nIHRvIHRoZSBFbmQtVXNlcidzIGxvY2FsZSBhbmQgcHJlZmVyZW5jZXMuCiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgZ3Jvb3Z5Lmpzb24uaW50ZXJuYWwuTGF6eU1hcCkgewogICAgICAgICAgCWlmICh2YWx1ZS5naXZlbk5hbWUgJiYgdmFsdWUuZmFtaWx5TmFtZSAmJiB2YWx1ZS5taWRkbGVOYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICJmYW1pbHlfbmFtZSI6IHZhbHVlLmZhbWlseU5hbWUsCiAgICAgICAgICAgICAgICAgICAgImdpdmVuX25hbWUiOiB2YWx1ZS5naXZlbk5hbWUsCiAgICAgICAgICAgICAgICAgIAkibWlkZGxlX25hbWUiOiB2YWx1ZS5taWRkbGVOYW1lLAogICAgICAgICAgICAgICAgICAgICJuYW1lIjogIiR2YWx1ZS5naXZlbk5hbWUgJHZhbHVlLm1pZGRsZU5hbWUgJHZhbHVlLmZhbWlseU5hbWUiLnRyaW0oKSwKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5naXZlbk5hbWUgJiYgdmFsdWUuZmFtaWx5TmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAiZmFtaWx5X25hbWUiOiB2YWx1ZS5mYW1pbHlOYW1lLAogICAgICAgICAgICAgICAgICAgICJnaXZlbl9uYW1lIjogdmFsdWUuZ2l2ZW5OYW1lLAogICAgICAgICAgICAgICAgICAgICJuYW1lIjogIiR2YWx1ZS5naXZlbk5hbWUgJHZhbHVlLmZhbWlseU5hbWUiLnRyaW0oKSwKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5mYW1pbHlOYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICJmYW1pbHlfbmFtZSI6IHZhbHVlLmZhbWlseU5hbWUsCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZS5mYW1pbHlOYW1lLAogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmdpdmVuTmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAiZ2l2ZW5fbmFtZSI6IHZhbHVlLmdpdmVuTmFtZSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHZhbHVlLmdpdmVuTmFtZSwKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgIm5hbWUiOiB2YWx1ZSwKICAgICAgICAgICAgXQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAibmFtZSI6IHZhbHVlLAogICAgICAgICAgICBdCiAgICAgICAgfQogICAgfQogICAgWzpdCn0KCmF0dHJpYnV0ZVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGZpZWxkLCB1c2VQcmltYXJ5LCBhZGRWZXJpZmllZCwgY2xhaW0sIGlkZW50aXR5IC0+CiAgCW5hbWUgPSBjbGFpbS5nZXROYW1lKCkKICAgIGxvZ2dlci5tZXNzYWdlKCJhdHRyaWJ1dGVSZXNvbHZlcjogIiArIG5hbWUpCiAgCiAgICB2YWx1ZSA9IGZyb21TZXQobmFtZSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCgogIAlpZiAodmFsdWUgIT0gbnVsbCAmJiAoY2xhaW0uZ2V0VmFsdWVzKCkgPT0gbnVsbCB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5pc0VtcHR5KCkgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuY29udGFpbnModmFsdWUpKSkgewogICAgICAgIHZhbHVlID0gdG9Kc29uKHZhbHVlKQogICAgICAgIGlmICh1c2VQcmltYXJ5KSB7CiAgICAgICAgICAgIHZhbHVlID0gZ2V0UHJpbWFyeU9yRmlyc3QodmFsdWUpCiAgICAgICAgfQogICAgICAKICAgICAgIAlpc01hcCA9IHZhbHVlICE9IG51bGwgJiYgdmFsdWUgaW5zdGFuY2VvZiBMYXp5TWFwCiAgICAgICAJaGFzRmllbGQgPSBpc01hcCAmJiBmaWVsZCBpbnN0YW5jZW9mIFN0cmluZyAmJiB2YWx1ZS5jb250YWluc0tleShmaWVsZCkKICAgICAgCWhhc1ZlcmlmaWVkID0gaXNNYXAgJiYgdmFsdWUuY29udGFpbnNLZXkoInZlcmlmaWVkIikKCiAgICAgIAlpZiAoYWRkVmVyaWZpZWQgJiYgaGFzVmVyaWZpZWQpIHsgICAgICAgICAgCQogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgKG5hbWUgKyAiX3ZlcmlmaWVkIik6IGhhc1ZlcmlmaWVkICYmIHZhbHVlLnZlcmlmaWVkID09IHRydWUsCiAgICAgICAgICAgICAgICAobmFtZSk6IGhhc0ZpZWxkID8gdmFsdWVbZmllbGRdIDogdmFsdWUsCiAgICAgICAgICAgIF0KICAgICAgICB9CiAgICAgIAogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIChuYW1lKTogaGFzRmllbGQgPyB2YWx1ZVtmaWVsZF0gOiB2YWx1ZSwKICAgICAgICBdCiAgICB9CiAgICBbOl0KfQoKYmFzaWNSZXNvbHZlciA9IHsgYXR0cmlidXRlLCBjbGFpbSwgaWRlbnRpdHkgLT4KICAgIG5hbWUgPSBjbGFpbS5nZXROYW1lKCkKICAgIGxvZ2dlci5tZXNzYWdlKCJiYXNpY1Jlc29sdmVyOiAiICsgbmFtZSkKICAgIHVzZXJQcm9maWxlVmFsdWUgPSBmcm9tU2V0KG5hbWUsIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCAmJiAoY2xhaW0uZ2V0VmFsdWVzKCkgPT0gbnVsbCB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5pc0VtcHR5KCkgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuY29udGFpbnModXNlclByb2ZpbGVWYWx1ZSkpKSB7CiAgICAgICAgZGVmIHZhbHVlID0gdG9Kc29uKHVzZXJQcm9maWxlVmFsdWUpCiAgICAgICAgdmFsdWUgPSBnZXRQcmltYXJ5T3JGaXJzdCh2YWx1ZSkKICAgICAgICByZXR1cm4gWyhuYW1lKTogdmFsdWVdCiAgICB9CiAgICBbOl0KfQoKZGF0ZVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgbmFtZSA9IGNsYWltLmdldE5hbWUoKQogICAgbG9nZ2VyLm1lc3NhZ2UoImRhdGVSZXNvbHZlcjogIiArIG5hbWUpCiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChuYW1lLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmICh1c2VyUHJvZmlsZVZhbHVlICE9IG51bGwgJiYgKGNsYWltLmdldFZhbHVlcygpID09IG51bGwgfHwgY2xhaW0uZ2V0VmFsdWVzKCkuaXNFbXB0eSgpIHx8IGNsYWltLmdldFZhbHVlcygpLmNvbnRhaW5zKHVzZXJQcm9maWxlVmFsdWUpKSkgewogICAgICAJZGVmIHZhbHVlID0gdG9Kc29uKHVzZXJQcm9maWxlVmFsdWUpCiAgICAgIAl2YWx1ZSA9IGdldFByaW1hcnlPckZpcnN0KHZhbHVlKQogICAgICAJZGVmIGRhdGUgPSBEYXRlLnBhcnNlKCJ5eXl5TU1kZEhIbW1zcyIsIHZhbHVlKTsKCQlyZXR1cm4gWyhuYW1lKTogZGF0ZS50aW1lIC8gMTAwMF0KICAgIH0KICAgIFs6XQp9CgpnZXRQcmltYXJ5T3JGaXJzdCA9IHsgdmFsdWUgLT4KICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGphdmEudXRpbC5BcnJheUxpc3QpIHsKICAgICAgICAvLyBsb29rIGZvciBwcmltYXJ5CiAgICAgICAgZm9yIChpdGVtIGluIHZhbHVlKSB7CiAgICAgICAgICAJb2JqID0gdG9Kc29uKGl0ZW0pCiAgICAgICAgICAgIGlmIChvYmouaGFzUHJvcGVydHkoInByaW1hcnkiKSAmJiBvYmoucHJpbWFyeSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gcmV0dXJuIGZpcnN0CiAgICAgICAgcmV0dXJuIHRvSnNvbih2YWx1ZVswXSkKICAgIH0KICAgIHJldHVybiB2YWx1ZQp9Cgp0b0pzb24gPSB7IHZhbHVlIC0+CiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBqYXZhLnV0aWwuSGFzaFNldCkgewogICAgICAgIGRlZiBqc29uU2V0ID0gW10KICAgICAgICB2YWx1ZS5lYWNoIHsgaSAtPgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAganNvblNldC5hZGQodG9Kc29uKGkpKQogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIGpzb25TZXQuYWRkKGkpCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiBqc29uU2V0CiAgICB9CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgSnNvblNsdXJwZXIoKS5wYXJzZVRleHQodmFsdWUpCiAgICB9IGNhdGNoKGUpIHsKICAgICAgICByZXR1cm4gdmFsdWUKICAgIH0KfQoKCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIHJlc29sdmVzIHRoZSB2YWx1ZSBvZiB0aGUgY2xhaW0gYnkgbG9va2luZyB1cCB0aGUgdXNlcidzIHByb2ZpbGUuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCByZXR1cm4gYSB2YWx1ZSBmb3IgdGhlIGNsYWltIGlmOgogKiAjIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgaXMgbm90IG51bGwKICogIyBBTkQgdGhlIGNsYWltIGNvbnRhaW5zIG5vIHJlcXVlc3RlZCB2YWx1ZXMKICogIyBPUiB0aGUgY2xhaW0gY29udGFpbnMgcmVxdWVzdGVkIHZhbHVlcyBhbmQgdGhlIHZhbHVlIGZyb20gdGhlIHVzZXIncyBwcm9maWxlIGlzIGluIHRoZSBsaXN0IG9mIHZhbHVlcwogKgogKiBJZiB0aGUgY2xhaW0gaXMgZXNzZW50aWFsIGFuZCBubyB2YWx1ZSBpcyBmb3VuZCBhbiBJbnZhbGlkUmVxdWVzdEV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBhbmQgcmV0dXJuZWQgdG8gdGhlIHVzZXIuCiAqIElmIG5vIG1hdGNoIGlzIGZvdW5kIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwplc3NlbnRpYWxDbGFpbVJlc29sdmVyID0geyBhdHRyaWJ1dGUsIGNsYWltLCBpZGVudGl0eSAtPgogICAgdXNlclByb2ZpbGVWYWx1ZSA9IGZyb21TZXQoY2xhaW0uZ2V0TmFtZSgpLCBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlKSkKICAgIGlmIChjbGFpbS5pc0Vzc2VudGlhbCgpICYmICh1c2VyUHJvZmlsZVZhbHVlID09IG51bGwgfHwgdXNlclByb2ZpbGVWYWx1ZS5pc0VtcHR5KCkpKSB7CiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRSZXF1ZXN0RXhjZXB0aW9uKCJDb3VsZCBub3QgcHJvdmlkZSB2YWx1ZSBmb3IgZXNzZW50aWFsIGNsYWltICRjbGFpbSIpCiAgICB9CiAgICBpZiAodXNlclByb2ZpbGVWYWx1ZSAhPSBudWxsICYmIChjbGFpbS5nZXRWYWx1ZXMoKSA9PSBudWxsIHx8IGNsYWltLmdldFZhbHVlcygpLmlzRW1wdHkoKSB8fCBjbGFpbS5nZXRWYWx1ZXMoKS5jb250YWlucyh1c2VyUHJvZmlsZVZhbHVlKSkpIHsKICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiB1c2VyUHJvZmlsZVZhbHVlXQogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gWzpdCiAgICB9Cn0KCi8qCiAqIENsYWltIHJlc29sdmVyIHdoaWNoIGV4cGVjdHMgdGhlIHVzZXIncyBwcm9maWxlIGF0dHJpYnV0ZSB2YWx1ZSB0byBiZSBpbiB0aGUgZm9sbG93aW5nIGZvcm1hdDoKICogImxhbmd1YWdlX3RhZ3x2YWx1ZV9mb3JfbGFuZ3VhZ2UsLi4uIi4KICoKICogVGhpcyByZXNvbHZlciB3aWxsIHRha2UgdGhlIGxpc3Qgb2YgcmVxdWVzdGVkIGxhbmd1YWdlcyBmcm9tIHRoZSAnY2xhaW1zX2xvY2FsZXMnIGF1dGhvcml6ZSByZXF1ZXN0CiAqIHBhcmFtZXRlciBhbmQgYXR0ZW1wdCB0byBtYXRjaCBpdCB0byBhIHZhbHVlIGZyb20gdGhlIHVzZXJzJyBwcm9maWxlIGF0dHJpYnV0ZS4KICogSWYgbm8gbWF0Y2ggaXMgZm91bmQgYW4gZXhjZXB0aW9uIGlzIHRocm93bi4KICovCmNsYWltTG9jYWxlc0NsYWltUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgIGxvY2FsZVZhbHVlcyA9IHBhcnNlTG9jYWxlQXdhcmVTdHJpbmcodXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICBsb2NhbGUgPSBjbGFpbXNMb2NhbGVzLmZpbmQgeyBsb2NhbGUgLT4gbG9jYWxlVmFsdWVzLmNvbnRhaW5zS2V5KGxvY2FsZSkgfQogICAgICAgIGlmIChsb2NhbGUgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkpOiBsb2NhbGVWYWx1ZXMuZ2V0KGxvY2FsZSldCiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIFs6XQp9CgovKgogKiBDbGFpbSByZXNvbHZlciB3aGljaCBleHBlY3RzIHRoZSB1c2VyJ3MgcHJvZmlsZSBhdHRyaWJ1dGUgdmFsdWUgdG8gYmUgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAqICJsYW5ndWFnZV90YWd8dmFsdWVfZm9yX2xhbmd1YWdlLC4uLiIuCiAqCiAqIFRoaXMgcmVzb2x2ZXIgd2lsbCB0YWtlIHRoZSBsYW5ndWFnZSB0YWcgc3BlY2lmaWVkIGluIHRoZSBjbGFpbSBvYmplY3QgYW5kIGF0dGVtcHQgdG8gbWF0Y2ggaXQgdG8gYSB2YWx1ZQogKiBmcm9tIHRoZSB1c2VycycgcHJvZmlsZSBhdHRyaWJ1dGUuIElmIG5vIG1hdGNoIGlzIGZvdW5kIGFuIGV4Y2VwdGlvbiBpcyB0aHJvd24uCiAqLwpsYW5ndWFnZVRhZ0NsYWltUmVzb2x2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5IC0+CiAgICB1c2VyUHJvZmlsZVZhbHVlID0gZnJvbVNldChjbGFpbS5nZXROYW1lKCksIGlkZW50aXR5LmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpKQogICAgaWYgKHVzZXJQcm9maWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgIGxvY2FsZVZhbHVlcyA9IHBhcnNlTG9jYWxlQXdhcmVTdHJpbmcodXNlclByb2ZpbGVWYWx1ZSkKICAgICAgICBpZiAoY2xhaW0uZ2V0TG9jYWxlKCkgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAobG9jYWxlVmFsdWVzLmNvbnRhaW5zS2V5KGNsYWltLmdldExvY2FsZSgpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsoY2xhaW0uZ2V0TmFtZSgpKTogbG9jYWxlVmFsdWVzLmdldChjbGFpbS5nZXRMb2NhbGUoKSldCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbnRyeSA9IGxvY2FsZVZhbHVlcy5lbnRyeVNldCgpLml0ZXJhdG9yKCkubmV4dCgpCiAgICAgICAgICAgICAgICByZXR1cm4gWyhjbGFpbS5nZXROYW1lKCkgKyAiIyIgKyBlbnRyeS5nZXRLZXkoKSk6IGVudHJ5LmdldFZhbHVlKCldCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbnRyeSA9IGxvY2FsZVZhbHVlcy5lbnRyeVNldCgpLml0ZXJhdG9yKCkubmV4dCgpCiAgICAgICAgICAgIHJldHVybiBbKGNsYWltLmdldE5hbWUoKSk6IGVudHJ5LmdldFZhbHVlKCldCiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIFs6XQp9CgovKgogKiBHaXZlbiBhIHN0cmluZyAiZW58RW5nbGlzaCxqcHxKYXBlbmVzZSxmcl9DQXxGcmVuY2ggQ2FuYWRpYW4iIHdpbGwgcmV0dXJuIG1hcCBvZiBsb2NhbGUgLT4gdmFsdWUuCiAqLwpwYXJzZUxvY2FsZUF3YXJlU3RyaW5nID0geyBzIC0+CiAgICByZXR1cm4gcmVzdWx0ID0gcy5zcGxpdCgiLCIpLmNvbGxlY3RFbnRyaWVzIHsgZW50cnkgLT4KICAgICAgICBzcGxpdCA9IGVudHJ5LnNwbGl0KCJcXHwiKQogICAgICAgIFsoc3BsaXRbMF0pOiB2YWx1ZSA9IHNwbGl0WzFdXQogICAgfQp9Ci8vIC0tLV5eXl5eXl5eXl4tLS0gRVhBTVBMRSBDTEFJTSBBVFRSSUJVVEUgUkVTT0xWRVIgRlVOQ1RJT05TIC0tLV5eXl5eXl5eXl4tLS0KCi8vIC0tLS0tLS0tLS0tLS0tIFVQREFURSBUSElTIFRPIENIQU5HRSBDTEFJTSBUTyBBVFRSSUJVVEUgTUFQUElORyBGVU5DVElPTlMgLS0tLS0tLS0tLS0tLS0tCi8qCiAqIExpc3Qgb2YgY2xhaW0gcmVzb2x2ZXIgbWFwcGluZ3MuCiAqLwovLyBbIHtjbGFpbX06IHthdHRyaWJ1dGUgcmV0cmlldmVyfSwgLi4uIF0KY2xhaW1BdHRyaWJ1dGVzID0gWwogICAgICAgICJhZGRyZXNzIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1hZGRyZXNzZXMiLCBmYWxzZSwgdHJ1ZSwgZmFsc2UpLAogICAgICAgICJiaXJ0aGRhdGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tYmlydGhkYXRlIiksCiAgICAgICAgImVtYWlsIjogYXR0cmlidXRlUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1lbWFpbHMiLCAidmFsdWUiLCB0cnVlLCB0cnVlKSwKICAgICAgICAiZ2VuZGVyIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLWdlbmRlciIpLAogICAgICAgICJsb2NhbGUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tbG9jYWxlIiksCiAgICAgICAgIm5hbWUiOiBuYW1lUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1uYW1lLW9iamVjdCIpLAogICAgICAgICJuaWNrbmFtZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1uaWNrLW5hbWUiKSwKICAgICAgICAicGhvbmUiOiBhdHRyaWJ1dGVSZXNvbHZlci5jdXJyeSgiZnItaWRtLXBob25lLW51bWJlcnMiLCAidmFsdWUiLCB0cnVlLCBmYWxzZSksCiAgICAgICAgInBpY3R1cmUiOiBhdHRyaWJ1dGVSZXNvbHZlci5jdXJyeSgiZnItaWRtLXBob3RvcyIsICJ2YWx1ZSIsIHRydWUsIGZhbHNlKSwKICAgICAgICAicHJlZmVycmVkX3VzZXJuYW1lIjogYmFzaWNSZXNvbHZlci5jdXJyeSgidXNlck5hbWUiKSwKICAgICAgICAicHJvZmlsZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS1wcm9maWxlLXVybCIpLAogICAgICAgICJ0aXRsZSI6IGJhc2ljUmVzb2x2ZXIuY3VycnkoImZyLWlkbS10aXRsZSIpLAogICAgICAgICJ1cGRhdGVkX2F0IjogZGF0ZVJlc29sdmVyLmN1cnJ5KCJtb2RpZnlUaW1lc3RhbXAiKSwKICAgICAgICAidXNlcm5hbWUiOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJ1c2VyTmFtZSIpLAogICAgICAgICJ3ZWJzaXRlIjogYmFzaWNSZXNvbHZlci5jdXJyeSgiZnItaWRtLXdlYnNpdGUiKSwKICAgICAgICAiem9uZWluZm8iOiBiYXNpY1Jlc29sdmVyLmN1cnJ5KCJmci1pZG0tdGltZXpvbmUiKSwKXQoKLy8gLS0tLS0tLS0tLS0tLS0gVVBEQVRFIFRISVMgVE8gQ0hBTkdFIFNDT1BFIFRPIENMQUlNIE1BUFBJTkdTIC0tLS0tLS0tLS0tLS0tCi8qCiAqIE1hcCBvZiBzY29wZXMgdG8gY2xhaW0gb2JqZWN0cy4KICovCi8vIHtzY29wZX06IFsge2NsYWltfSwgLi4uIF0KLy8gaHR0cHM6Ly90cmVsbG8uY29tL2Mvd0hBM2VicDEvMTAyMS1pZC10b2tlbi1hbmQtdXNlcmluZm8tZW5kcG9pbnQtbm90LXJldHVybmluZy1hbGwtdXNlci1kYXRhCnNjb3BlQ2xhaW1zTWFwID0gWwogICAgICAgICJlbWFpbCI6IFsgImVtYWlsIiBdLAogICAgICAgICJhZGRyZXNzIjogWyAiYWRkcmVzcyIgXSwKICAgICAgICAicGhvbmUiOiBbICJwaG9uZSIgXSwKICAgICAgICAicHJvZmlsZSI6IFsKICAgICAgICAgICAgImJpcnRoZGF0ZSIsCiAgICAgICAgICAgICJmYW1pbHlfbmFtZSIsCiAgICAgICAgICAgICJnZW5kZXIiLAogICAgICAgICAgICAiZ2l2ZW5fbmFtZSIsCiAgICAgICAgICAgICJsb2NhbGUiLAogICAgICAgICAgICAibmFtZSIsCiAgICAgICAgICAgICJuaWNrbmFtZSIsCiAgICAgICAgICAgICJwaWN0dXJlIiwKICAgICAgICAgICAgInByZWZlcnJlZF91c2VybmFtZSIsCiAgICAgICAgICAgICJwcm9maWxlIiwKICAgICAgICAgICAgInRpdGxlIiwKICAgICAgICAgICAgInVwZGF0ZWRfYXQiLAogICAgICAgICAgICAidXNlcm5hbWUiLAogICAgICAgICAgICAid2Vic2l0ZSIsCiAgICAgICAgICAgICJ6b25laW5mbyIsCiAgICAgICAgXQpdCgovLyAtLS0tLS0tLS0tLS0tLS0tIFVQREFURSBCRUxPVyBGT1IgQURWQU5DRUQgVVNBR0VTIC0tLS0tLS0tLS0tLS0tLS0tLS0KaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICBzY29wZXMuZmluZEFsbCB7IHMgLT4gISgib3BlbmlkIi5lcXVhbHMocykgfHwgc2NvcGVDbGFpbXNNYXAuY29udGFpbnNLZXkocykpIH0uZWFjaCB7IHMgLT4KICAgICAgICBsb2dnZXIubWVzc2FnZSgiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTo6TWVzc2FnZTogc2NvcGUgbm90IGJvdW5kIHRvIGNsYWltczogJHMiKQogICAgfQp9CgovKgogKiBDb21wdXRlcyB0aGUgY2xhaW1zIHJldHVybiBrZXkgYW5kIHZhbHVlLiBUaGUga2V5IG1heSBiZSBhIGRpZmZlcmVudCB2YWx1ZSBpZiB0aGUgY2xhaW0gdmFsdWUgaXMgbm90IGluCiAqIHRoZSByZXF1ZXN0ZWQgbGFuZ3VhZ2UuCiAqLwpkZWYgY29tcHV0ZUNsYWltID0geyBjbGFpbSAtPgogICAgdHJ5IHsKICAgICAgICBjbGFpbVJlc29sdmVyID0gY2xhaW1BdHRyaWJ1dGVzLmdldChjbGFpbS5nZXROYW1lKCksIHsgY2xhaW1PYmosIGlkZW50aXR5IC0+IGRlZmF1bHRDbGFpbVJlc29sdmVyKGNsYWltKX0pCiAgICAgICAgY2xhaW1SZXNvbHZlcihjbGFpbSwgaWRlbnRpdHkpCiAgICB9IGNhdGNoIChJZFJlcG9FeGNlcHRpb24gZSkgewogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogVW5hYmxlIHRvIHJldHJpZXZlIGF0dHJpYnV0ZT0kYXR0cmlidXRlIiwgZSk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoU1NPRXhjZXB0aW9uIGUpIHsKICAgICAgICBpZiAobG9nZ2VyLndhcm5pbmdFbmFibGVkKCkpIHsKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IFVuYWJsZSB0byByZXRyaWV2ZSBhdHRyaWJ1dGU9JGF0dHJpYnV0ZSIsIGUpOwogICAgICAgIH0KICAgIH0KfQoKLyoKICogQ29udmVydHMgcmVxdWVzdGVkIHNjb3BlcyBpbnRvIGNsYWltIG9iamVjdHMgYmFzZWQgb24gdGhlIHNjb3BlIG1hcHBpbmdzIGluIHNjb3BlQ2xhaW1zTWFwLgogKi8KZGVmIGNvbnZlcnRTY29wZVRvQ2xhaW1zID0gewogICAgc2NvcGVzLmZpbmRBbGwgeyBzY29wZSAtPiAib3BlbmlkIiAhPSBzY29wZSAmJiBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzY29wZSkgfS5jb2xsZWN0TWFueSB7IHNjb3BlIC0+CiAgICAgICAgc2NvcGVDbGFpbXNNYXAuZ2V0KHNjb3BlKS5jb2xsZWN0IHsgY2xhaW0gLT4KICAgICAgICAgICAgbmV3IENsYWltKGNsYWltKQogICAgICAgIH0KICAgIH0KfQoKLy8gQ3JlYXRlcyBhIGZ1bGwgbGlzdCBvZiBjbGFpbXMgdG8gcmVzb2x2ZSBmcm9tIHJlcXVlc3RlZCBzY29wZXMsIGNsYWltcyBwcm92aWRlZCBieSBBUyBhbmQgcmVxdWVzdGVkIGNsYWltcwpkZWYgY2xhaW1zVG9SZXNvbHZlID0gY29udmVydFNjb3BlVG9DbGFpbXMoKSArIGNsYWltT2JqZWN0cyArIHJlcXVlc3RlZFR5cGVkQ2xhaW1zCgovLyBDb21wdXRlcyB0aGUgY2xhaW0gcmV0dXJuIGtleSBhbmQgdmFsdWVzIGZvciBhbGwgcmVxdWVzdGVkIGNsYWltcwpjb21wdXRlZENsYWltcyA9IGNsYWltc1RvUmVzb2x2ZS5jb2xsZWN0RW50cmllcygpIHsgY2xhaW0gLT4KICAgIGNvbXB1dGVDbGFpbShjbGFpbSkKfQoKLy8gQ29tcHV0ZXMgY29tcG9zaXRlIHNjb3BlcwpkZWYgY29tcG9zaXRlU2NvcGVzID0gc2NvcGVDbGFpbXNNYXAuZmluZEFsbCB7IHNjb3BlIC0+CiAgICBzY29wZXMuY29udGFpbnMoc2NvcGUua2V5KQp9CgpyZXR1cm4gbmV3IFVzZXJJbmZvQ2xhaW1zKChNYXApY29tcHV0ZWRDbGFpbXMsIChNYXApY29tcG9zaXRlU2NvcGVzKQ==",
    "default": true,
    "language": "GROOVY",
    "context": "OIDC_CLAIMS",
    "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "creationDate": 1433147666269,
    "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org",
    "lastModifiedDate": 1433147666269
  }
}
