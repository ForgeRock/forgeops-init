{
  "metadata" : {
    "realm" : "/",
    "amsterVersion" : "7.0.0-SNAPSHOT",
    "entityType" : "ScriptingService",
    "entityId" : "default/scriptConfigurations/d25827fa-9eb9-4bbf-abe5-8d0b3c8f2b46",
    "serviceVersion" : "24b09aa8-a51c-4ccf-a07c-9a9dd08eeefd",
    "uid" : "ou=d25827fa-9eb9-4bbf-abe5-8d0b3c8f2b46,ou=scriptConfigurations,ou=default,ou=OrganizationConfig,ou=1.0,ou=ScriptingService,ou=services,ou=am-config",
    "sunServiceID" : "scriptConfiguration",
    "objectClass" : [ "top", "sunServiceComponent" ],
    "pathParams" : { },
    "ou" : [ "d25827fa-9eb9-4bbf-abe5-8d0b3c8f2b46" ]
  },
  "data" : {
    "lastModifiedDate" : "0",
    "createdBy" : "null",
    "lastModifiedBy" : "null",
    "_type" : {
      "_id" : "ScriptingService",
      "name" : "ScriptingService",
      "collection" : false
    },
    "name" : "Email with org-api template",
    "context" : "AUTHENTICATION_TREE_DECISION_NODE",
    "description" : "Custom script to send a One Time Passcode using org-api. Parameters for OpenIDM credentials, OpenIDM URL, and org-api URL need to be populated. OTP email template can be changed through org-ui.",
    "language" : "JAVASCRIPT",
    "_id" : "default/scriptConfigurations/d25827fa-9eb9-4bbf-abe5-8d0b3c8f2b46",
    "creationDate" : "0",
    "script" : "dmFyIGZyID0gbmV3IEphdmFJbXBvcnRlcigKICBvcmcuZm9yZ2Vyb2NrLmh0dHAucHJvdG9jb2wsCiAgb3JnLmZvcmdlcm9jay51dGlsLnByb21pc2UsCiAgb3JnLmZvcmdlcm9jay5vcGVuYW0uYXV0aC5ub2RlcywKICBvcmcuZm9yZ2Vyb2NrLmd1aWNlLmNvcmUKKTsKCnZhciBPUkdfQVBJX1ZBUl9VUkwgPSAiaHR0cDovL29yZy1hcGkub3JnLXByaXZhdGU6ODA4MCI7CnZhciBJRE1fVkFSX1VSTCA9ICJodHRwOi8vb3BlbmlkbS5mci1wbGF0Zm9ybS8iOwp2YXIgSURNX1ZBUl9VU0VSTkFNRSA9ICJvcGVuaWRtLWFkbWluIjsKdmFyIElETV9WQVJfUEFTU1dPUkQgPSAib3BlbmlkbS1hZG1pbiI7CgpmdW5jdGlvbiBnZXRVVUlERnJvbUlETUJ5VXNlcm5hbWUodXNlcm5hbWUpIHsKICB3aXRoIChmcikgewogICAgdmFyIGVuY29kZWROYW1lID0gZW5jb2RlVVJJQ29tcG9uZW50KCciJyArIHVzZXJuYW1lICsgJyInKTsKICAgIHZhciBpZG1fdXJsID0gSURNX1ZBUl9VUkwucmVwbGFjZSgvXC9bXHNdKiQvLCcnKTsKICAgIHZhciB1cmwgPQogICAgICBpZG1fdXJsICsKICAgICAgIi9vcGVuaWRtL21hbmFnZWQvdXNlcj9fcXVlcnlGaWx0ZXI9KHVzZXJOYW1lK2VxKyIgKwogICAgICBlbmNvZGVkTmFtZSArCiAgICAgICIpJl9maWVsZHM9X2lkIjsKCiAgICBsb2dnZXIuZXJyb3IoIklETSBVUkw6ICIgKyB1cmwpOwoKICAgIHZhciByZXF1ZXN0ID0gbmV3IFJlcXVlc3QoKTsKICAgIHJlcXVlc3QubWV0aG9kID0gIkdFVCI7CiAgICByZXF1ZXN0LnNldFVyaSh1cmwpOwoKICAgIHZhciBoZWFkZXJzID0gcmVxdWVzdC5nZXRIZWFkZXJzKCkKICAgIGhlYWRlcnMuYWRkKCJBY2NlcHQiLCAiYXBwbGljYXRpb24vanNvbiIpOwogICAgaGVhZGVycy5hZGQoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIik7CiAgICBoZWFkZXJzLmFkZCgiWC1SZXF1ZXN0ZWQtV2l0aCIsICJvcGVuYW0tc2VuZC10ZW1wbGF0ZWQtZW1haWwiKTsKICAgIGhlYWRlcnMuYWRkKCJYLU9wZW5JRE0tVXNlcm5hbWUiLCBJRE1fVkFSX1VTRVJOQU1FKTsKICAgIGhlYWRlcnMuYWRkKCJYLU9wZW5JRE0tUGFzc3dvcmQiLCBJRE1fVkFSX1BBU1NXT1JEKTsKCiAgICBwcm9taXNlID0gaHR0cENsaWVudC5zZW5kKHJlcXVlc3QpOwogICAgdmFyIHJlc3BvbnNlID0gcHJvbWlzZS5nZXQoKTsKCiAgICBsb2dnZXIubWVzc2FnZSgiSURNIHJlc3BvbnNlIHN0YXR1czogIiArIHJlc3BvbnNlLnN0YXR1cyk7CgogICAgaWYgKHJlc3BvbnNlLmdldFN0YXR1cygpLmdldENvZGUoKSA9PSAyMDApIHsKICAgICAgZW50aXR5ID0gcmVzcG9uc2UuZ2V0RW50aXR5KCkuZ2V0U3RyaW5nKCk7CiAgICAgIHZhciBkYXRhID0gSlNPTi5wYXJzZShlbnRpdHkpOwoKICAgICAgaWYgKGRhdGEucmVzdWx0Q291bnQgPiAwKSB7CiAgICAgICAgcmV0dXJuIGRhdGEucmVzdWx0WzBdLl9pZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQp9CgpmdW5jdGlvbiBnZXRPVFBSZXF1ZXN0Qm9keSh1dWlkLCBvdHApIHsKICB2YXIgYm9keSA9IHsKICAgIHRlbXBsYXRlVHlwZTogIm9uZS10aW1lLXBhc3Njb2RlIiwKICAgIHVzZXJJZDogdXVpZCwKICAgIHBhcmFtczogewogICAgICBvdHA6IG90cC50b1N0cmluZygpCiAgICB9CiAgfTsKICByZXR1cm4gYm9keTsKfQoKZnVuY3Rpb24gc2VuZE9UUFJlcXVlc3QodXNlcm5hbWUsIG90cCkgewogIHdpdGggKGZyKSB7CiAgICB2YXIgb3JnX2FwaV91cmwgPSBPUkdfQVBJX1ZBUl9VUkwucmVwbGFjZSgvXC9bXHNdKiQvLCcnKTsKICAgIHZhciB1cmwgPSBvcmdfYXBpX3VybCArICIvdjEvZW1haWwiOwogICAgdmFyIHV1aWQgPSBnZXRVVUlERnJvbUlETUJ5VXNlcm5hbWUodXNlcm5hbWUpOwoKICAgIGlmICh1dWlkID09IG51bGwpIHsKICAgICAgbG9nZ2VyLmVycm9yKAogICAgICAgICJ1bmFibGUgdG8gZ2V0IGZyLWlkbS11dWlkIGZyb20gSURNIGZvciB1c2VybmFtZSAiICsgdXNlcm5hbWUKICAgICAgKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgbG9nZ2VyLm1lc3NhZ2UoInV1aWQ6ICIgKyB1dWlkKTsKCiAgICB2YXIgcmVxdWVzdCA9IG5ldyBSZXF1ZXN0KCk7CiAgICByZXF1ZXN0Lm1ldGhvZCA9ICJQT1NUIjsKICAgIHJlcXVlc3Quc2V0VXJpKHVybCk7CiAgICB2YXIgaGVhZGVycyA9IHJlcXVlc3QuZ2V0SGVhZGVycygpCiAgICBoZWFkZXJzLmFkZCgiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb24iKTsKICAgIGhlYWRlcnMuYWRkKCJYLVJlcXVlc3RlZC1XaXRoIiwgIm9wZW5hbS1zZW5kLXRlbXBsYXRlZC1lbWFpbCIpOwogICAgdmFyIGJvZHkgPSBnZXRPVFBSZXF1ZXN0Qm9keSh1dWlkLCBvdHApOwogICAgcmVxdWVzdC5zZXRFbnRpdHkoYm9keSk7CiAgICBwcm9taXNlID0gaHR0cENsaWVudC5zZW5kKHJlcXVlc3QpOwogICAgdmFyIHJlc3BvbnNlID0gcHJvbWlzZS5nZXQoKTsKCiAgICB2YXIgbWVzc2FnZSA9ICJUZW1wbGF0ZWQgRW1haWwgU3RhdHVzOiAiICsgcmVzcG9uc2UuZ2V0U3RhdHVzKCkgKyAiLCBDYXVzZTogIiArIHJlc3BvbnNlLmdldENhdXNlKCk7CiAgICBpZihyZXNwb25zZS5nZXRTdGF0dXMoKS5nZXRDb2RlKCkgPj0gMjAwICYmIHJlc3BvbnNlLmdldFN0YXR1cygpLmdldENvZGUoKSA8IDI5OSkgewogICAgICAgIGxvZ2dlci5tZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgCiAgICBsb2dnZXIuZXJyb3IobWVzc2FnZSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9CgpmdW5jdGlvbiBwb3N0RW1haWwoKSB7CiAgd2l0aCAoZnIpIHsKICAgIHZhciB1c2VybmFtZSA9IHNoYXJlZFN0YXRlLmdldCgidXNlcm5hbWUiKTsKICAgIHZhciBvdHAgPSBzaGFyZWRTdGF0ZS5nZXQoIm9uZVRpbWVQYXNzd29yZCIpOwoKICAgIGxvZ2dlci5tZXNzYWdlKCJ1c2VybmFtZTogIiArIHVzZXJuYW1lKTsKICAgIGxvZ2dlci5tZXNzYWdlKCJvdHA6ICIgKyBvdHApOwoKICAgIHNlbmRPVFBSZXF1ZXN0KHVzZXJuYW1lLCBvdHApOwogIH0KfQoKcG9zdEVtYWlsKCk7Cm91dGNvbWUgPSAib3V0Y29tZSI7"
  }
}